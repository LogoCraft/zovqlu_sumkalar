<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Çanta Cenneti - Admin (Mubag_Style)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  #drop-zone.dragover { border-color: #1A4731; background:#f7f3e8b3 }
</style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">

<div class="max-w-5xl mx-auto">

  <!-- Top -->
  <header class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">Çanta Cenneti — Yönetim</h1>
    <div id="auth-area" class="flex items-center gap-4"></div>
  </header>

  <!-- MAIN VIEWS -->
  <div id="main-view">

    <!-- Admin login -->
    <div id="login-card" class="bg-white p-6 rounded shadow mb-6 max-w-md">
      <h2 class="font-semibold mb-4">Admin Girişi (Supabase Auth)</h2>
      <form id="login-form" class="space-y-3">
        <input id="login-email" type="email" placeholder="Email" class="w-full p-2 border rounded" required />
        <input id="login-pass" type="password" placeholder="Şifre" class="w-full p-2 border rounded" required />
        <div class="flex gap-2">
          <button class="bg-green-700 text-white px-4 py-2 rounded" type="submit">Giriş Yap</button>
          <button id="register-btn" type="button" class="bg-gray-200 px-4 py-2 rounded">Kayıt Ol (test)</button>
        </div>
        <p id="login-msg" class="text-sm text-red-600"></p>
      </form>
    </div>

    <!-- Admin panel (gizli, gösterilcek giriş sonrası) -->
    <div id="admin-panel" class="hidden">

      <!-- New product form (multi images + category) -->
      <div class="bg-white p-6 rounded shadow mb-6">
        <h2 class="font-semibold mb-4">Yeni Ürün Ekle / Düzenle</h2>

        <form id="product-form" class="space-y-3">
          <input id="product-id" type="hidden" />
          <div><input id="product-name" placeholder="Ürün adı" class="w-full p-2 border rounded" required /></div>
          <div><textarea id="product-desc" rows="2" placeholder="Açıklama" class="w-full p-2 border rounded"></textarea></div>
          <div><input id="product-price" type="number" step="0.01" placeholder="Fiyat" class="w-full p-2 border rounded" required /></div>

          <div>
            <label class="block mb-1">Kategori</label>
            <div class="flex gap-2">
              <select id="category-select" class="p-2 border rounded flex-1"></select>
              <input id="new-category" placeholder="Yeni kategori ekle" class="p-2 border rounded w-48" />
              <button id="add-category-btn" type="button" class="px-3 bg-blue-600 text-white rounded">Ekle</button>
            </div>
          </div>

          <div>
            <label class="block mb-1">Fotoğraflar (Çoklu)</label>
            <div id="drop-zone" class="p-6 border-2 border-dashed rounded cursor-pointer text-center">
              <p>Dosyaları sürükle veya seç (JPG/PNG/WebP) — max 2MB / dosya</p>
              <input id="file-input" type="file" accept="image/jpeg,image/png,image/webp,image/gif" multiple class="hidden" />
            </div>
            <div id="thumbs" class="flex gap-2 mt-3 flex-wrap"></div>
          </div>

          <div class="flex gap-2">
            <button id="save-btn" class="bg-green-700 text-white px-4 py-2 rounded" type="submit">Kaydet</button>
            <button id="cancel-edit" type="button" class="bg-gray-200 px-4 py-2 rounded">İptal</button>
          </div>
          <p id="form-status" class="text-sm"></p>
        </form>
      </div>

      <!-- Product list (admin) -->
      <div class="bg-white p-6 rounded shadow">
        <h2 class="font-semibold mb-4">Mevcut Ürünler</h2>
        <div id="admin-product-list" class="space-y-3"></div>
      </div>

      <!-- Public product grid (gözlem) -->
      <div class="mt-6 bg-white p-6 rounded shadow">
        <h2 class="font-semibold mb-4">Site Önizleme</h2>
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const SUPABASE_URL = "https://wlnffeirtmjikbgggckn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbmZmZWlydG1qaWtiZ2dnY2tuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MTc4NzMsImV4cCI6MjA3ODI5Mzg3M30.bcKzldG9TuH8T_xMwtsoZ7aYKI_J4Cb5UapFDI00mVo";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---------- CONFIG ----------
const BUCKET = "Mubag_Style";
const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB
const ALLOWED = ["image/jpeg","image/png","image/webp","image/gif"];

// Admin olarak tanımlanacak e-posta (değiştir!)
const ADMIN_EMAIL = "admin@yourdomain.com";

// ---------- STATE ----------
let selectedFiles = []; // File objects
let categories = [];

// ---------- HELPERS ----------
function el(id){ return document.getElementById(id); }
function showAdminPanel(user) {
  el("login-card").classList.add("hidden");
  el("admin-panel").classList.remove("hidden");
  // auth-area güncelle
  el("auth-area").innerHTML = `
    <div class="text-sm">Hoşgeldin: ${user.email}</div>
    <button id="signout-btn" class="bg-red-600 text-white px-3 py-1 rounded">Çıkış</button>
  `;
  el("signout-btn").onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  };
}

// Upload single file -> public url
async function uploadSingleFile(file, folder="") {
  const ext = file.name.split(".").pop();
  const key = (folder ? folder + "/" : "") + `img_${Date.now()}_${Math.floor(Math.random()*10000)}.${ext}`;
  // upload
  const { error } = await supabase.storage.from(BUCKET).upload(key, file);
  if (error) {
    console.error("Upload error:", error);
    return null;
  }
  const { data } = supabase.storage.from(BUCKET).getPublicUrl(key);
  return data?.publicUrl ?? null;
}

// Upload multiple files -> returns array of urls (parallel)
async function uploadFiles(files) {
  const urls = [];
  for (const f of files) {
    const u = await uploadSingleFile(f);
    if (!u) return null;
    urls.push(u);
  }
  return urls;
}

// get products
async function getProducts() {
  const { data, error } = await supabase.from("products").select("*").order("id",{ascending:false});
  if (error) { console.error(error); return []; }
  return data || [];
}

// save new product
async function saveProduct(product) {
  const { data, error } = await supabase.from("products").insert(product).select();
  if (error) { console.error(error); return null; }
  return data ? data[0] : null;
}

// update product
async function updateProduct(id, payload) {
  const { data, error } = await supabase.from("products").update(payload).eq("id", id).select();
  if (error) { console.error(error); return null; }
  return data ? data[0] : null;
}

// delete product
async function deleteProduct(id) {
  await supabase.from("products").delete().eq("id", id);
  await refreshAll();
}

// categories
async function loadCategories() {
  const { data, error } = await supabase.from("categories").select("*").order("id",{ascending:true});
  categories = (error || !data) ? [] : data.map(c=>c.name);
  renderCategoryOptions();
}
function renderCategoryOptions() {
  const sel = el("category-select");
  sel.innerHTML = "<option value=''>--Kategori seç--</option>";
  categories.forEach(c => sel.insertAdjacentHTML("beforeend", `<option value="${c}">${c}</option>`));
}

// add category
async function addCategory(name) {
  if (!name) return;
  await supabase.from("categories").insert({ name }).select();
  await loadCategories();
}

// ---------- UI RENDER ----------
function renderAdminList(products) {
  const wrap = el("admin-product-list");
  wrap.innerHTML = "";
  if (!products.length) { wrap.innerHTML = "<p>Henüz ürün yok.</p>"; return; }
  products.forEach(p => {
    const firstImg = (p.image_urls && p.image_urls.length) ? p.image_urls[0] : "";
    wrap.insertAdjacentHTML("beforeend", `
      <div class="flex items-center justify-between p-3 border rounded">
        <div class="flex items-center gap-3">
          <img src="${firstImg}" class="w-16 h-16 object-cover rounded" />
          <div>
            <div class="font-semibold">${p.name}</div>
            <div class="text-sm text-gray-600">${p.category || ""}</div>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="edit-btn bg-yellow-400 px-3 py-1 rounded" data-id="${p.id}">Düzenle</button>
          <button class="del-btn bg-red-600 text-white px-3 py-1 rounded" data-id="${p.id}">Sil</button>
        </div>
      </div>
    `);
  });
  // events
  wrap.querySelectorAll(".edit-btn").forEach(b => b.onclick = () => startEdit(b.dataset.id, products));
  wrap.querySelectorAll(".del-btn").forEach(b => {
    b.onclick = async () => {
      if (!confirm("Ürün silinsin mi?")) return;
      await deleteProduct(b.dataset.id);
    };
  });
}

function renderGrid(products) {
  const grid = el("product-grid");
  grid.innerHTML = "";
  if (!products.length) { grid.innerHTML = "<p>Henüz ürün yok.</p>"; return; }
  products.forEach(p => {
    const first = (p.image_urls && p.image_urls.length) ? p.image_urls[0] : "";
    grid.insertAdjacentHTML("beforeend", `
      <div class="border rounded overflow-hidden">
        <img src="${first}" class="w-full h-48 object-cover" />
        <div class="p-3">
          <h3 class="font-semibold">${p.name}</h3>
          <div class="text-sm text-gray-600">${p.category || ""}</div>
          <div class="mt-2 font-semibold">${p.price} ₺</div>
        </div>
      </div>
    `);
  });
}

// ---------- EDIT FLOW ----------
function startEdit(id, products) {
  const p = products.find(x => String(x.id) === String(id));
  if (!p) return;
  // fill form
  el("product-id").value = p.id;
  el("product-name").value = p.name;
  el("product-desc").value = p.description || "";
  el("product-price").value = p.price || "";
  el("category-select").value = p.category || "";
  // show thumbs for existing images (not files)
  const thumbs = el("thumbs");
  thumbs.innerHTML = "";
  (p.image_urls || []).forEach(url => {
    const div = document.createElement("div");
    div.className = "w-24 h-24 border rounded overflow-hidden relative";
    div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" />`;
    thumbs.appendChild(div);
  });
  // clear selectedFiles to avoid accidental overwrite
  selectedFiles = [];
  // scroll to form
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// ---------- REFRESH ----------
async function refreshAll() {
  const prods = await getProducts();
  renderAdminList(prods);
  renderGrid(prods);
}

// ---------- EVENTS ----------
window.onload = async () => {
  // auth check
  const { data: { session } } = await supabase.auth.getSession();
  if (session && session.user && session.user.email === ADMIN_EMAIL) {
    showAdminPanel(session.user);
    await loadCategories();
    await refreshAll();
  } else {
    el("login-card").classList.remove("hidden");
  }

  // login form
  el("login-form").onsubmit = async (e) => {
    e.preventDefault();
    el("login-msg").textContent = "";
    const email = el("login-email").value;
    const pass = el("login-pass").value;
    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) { el("login-msg").textContent = error.message; return; }
      if (data && data.user && data.user.email === ADMIN_EMAIL) {
        showAdminPanel(data.user);
        await loadCategories();
        await refreshAll();
      } else {
        // allow sign in but check admin email
        if (data && data.user) {
          el("login-msg").textContent = "Bu e-posta admin değil.";
          await supabase.auth.signOut();
        }
      }
    } catch(err){ el("login-msg").textContent = err.message; }
  };

  // quick register (test) - create a user in Supabase (dev convenience)
  el("register-btn").onclick = async () => {
    const email = el("login-email").value;
    const pass = el("login-pass").value;
    if(!email||!pass){ el("login-msg").textContent="Email ve şifre girin"; return; }
    const { data, error } = await supabase.auth.signUp({ email, password: pass });
    if (error) el("login-msg").textContent = error.message;
    else el("login-msg").textContent = "Kayıt isteği gönderildi. Supabase auth kullanıcılar bölümünden e-postayı onayla ve admin email yap.";
  };

  // drop zone + file input
  const dz = el("drop-zone"), fi = el("file-input");
  dz.onclick = () => fi.click();
  fi.onchange = e => handleFileList(e.target.files);
  ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add("dragover"); }));
  ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => {
    e.preventDefault(); dz.classList.remove("dragover");
    if (ev==="drop" && e.dataTransfer.files[0]) handleFileList(e.dataTransfer.files);
  }));

  // add category
  el("add-category-btn").onclick = async () => {
    const v = el("new-category").value.trim();
    if (!v) return;
    await addCategory(v);
    el("new-category").value = "";
  };

  // cancel edit
  el("cancel-edit").onclick = () => {
    el("product-form").reset();
    selectedFiles = [];
    el("thumbs").innerHTML = "";
    el("product-id").value = "";
  };

  // save product (insert or update)
  el("product-form").onsubmit = async (e) => {
    e.preventDefault();
    const status = el("form-status"); status.textContent = "";
    const id = el("product-id").value;
    const name = el("product-name").value.trim();
    const desc = el("product-desc").value.trim();
    const price = parseFloat(el("product-price").value) || 0;
    const category = el("category-select").value || "";

    if (!name) { status.textContent = "Ürün adı gerekli."; return; }

    // if new files selected -> upload them and set image_urls
    let uploadedUrls = null;
    if (selectedFiles.length) {
      status.textContent = "Resimler yükleniyor...";
      uploadedUrls = await uploadFiles(selectedFiles);
      if (!uploadedUrls) { status.textContent = "Resim yükleme hatası."; return; }
    }

    // payload
    const payload = {
      name, description: desc, price, category
    };
    if (uploadedUrls) payload.image_urls = uploadedUrls;

    if (!id) {
      // create
      const created = await saveProduct(payload);
      if (!created) { status.textContent = "Ürün kaydedilemedi."; return; }
      status.textContent = "Ürün eklendi.";
    } else {
      // update existing: if uploadedUrls set -> replace image_urls; else keep existing
      const updated = await updateProduct(id, payload);
      if (!updated) { status.textContent = "Güncelleme başarısız."; return; }
      status.textContent = "Ürün güncellendi.";
    }

    // reset form
    el("product-form").reset();
    selectedFiles = [];
    el("thumbs").innerHTML = "";
    el("product-id").value = "";
    await refreshAll();
    setTimeout(()=>status.textContent="",2000);
  };

  // load categories & products for initial
  await loadCategories();
  await refreshAll();
};

// file handling with checks and thumbnails
function handleFileList(fileList) {
  const arr = Array.from(fileList);
  const thumbs = el("thumbs");
  for (const f of arr) {
    if (!ALLOWED.includes(f.type)) { alert("Sadece JPG/PNG/WebP/GIF izinli."); continue; }
    if (f.size > MAX_FILE_SIZE) { alert("Maksimum dosya boyutu 2MB."); continue; }
    selectedFiles.push(f);
    // thumb
    const reader = new FileReader();
    reader.onload = e => {
      const div = document.createElement("div");
      div.className = "w-24 h-24 border rounded overflow-hidden relative";
      div.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" />`;
      thumbs.appendChild(div);
    };
    reader.readAsDataURL(f);
  }
}
</script>
</body>
</html>
