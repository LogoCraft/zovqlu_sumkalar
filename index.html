<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mulink Yapay Zeka Asistanı</title>
  <!-- Tailwind CSS yüklemesi --><script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    :root { font-family: 'Inter', sans-serif; }

    body, html { height: 100%; overflow: hidden; }
    
    /* Özel kaydırma çubuğu stilleri */
    #chat-container::-webkit-scrollbar,
    #sidebar-content::-webkit-scrollbar { width: 6px; }
    #chat-container::-webkit-scrollbar-thumb,
    #sidebar-content::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 3px; }
    #chat-container::-webkit-scrollbar-track,
    #sidebar-content::-webkit-scrollbar-track { background-color: #1f2937; }

    /* Sidebar geçiş stilleri */
    .sidebar {
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }
    .sidebar.open { transform: translateX(0); }
    @media (min-width: 640px) {
      .sidebar { transform: translateX(0); }
    }
    .overlay {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .overlay.open {
      visibility: visible;
      opacity: 1;
    }
    .ai-message a { color: #818cf8; text-decoration: underline; }
    /* Yüklenme animasyonu stilleri */
    .loading-animation {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex">

  <!-- Sidebar --><aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-40 w-64 bg-gray-800 shadow-xl flex flex-col sm:relative">
    <header class="p-4 bg-gray-900 border-b border-gray-700">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-indigo-400">Konuşmalar</h2>
        <button onclick="toggleSidebar()" class="sm:hidden text-gray-400 hover:text-white p-1">
          ✕
        </button>
      </div>
      <button id="new-chat-button" onclick="startNewConversation()" class="mt-3 w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition">
        + Yeni Konu Başlat
      </button>
    </header>
    <div id="sidebar-content" class="flex-grow overflow-y-auto p-2 space-y-2">
      <p id="loading-conversations" class="text-sm text-gray-400 text-center mt-4">Konuşmalar yükleniyor...</p>
    </div>
  </aside>

  <!-- Overlay --><div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-30 sm:hidden" onclick="toggleSidebar()"></div>

  <!-- Ana Alan --><main class="flex-grow flex flex-col bg-gray-800">
    <header class="p-4 bg-gray-900 flex items-center border-b border-gray-700 shadow-md">
      <button onclick="toggleSidebar()" class="sm:hidden text-gray-400 hover:text-white mr-3">☰</button>
      <h1 class="text-xl font-extrabold text-indigo-400 flex-grow" id="current-topic-title">Mulink Asistan (Local Storage)</h1>
    </header>

    <div id="chat-container" class="flex-grow p-4 space-y-4 overflow-y-auto">
      <div id="loading-history" class="text-center text-sm text-gray-400 mt-4">Lütfen bekleyin, oturum başlatılıyor...</div>
    </div>

    <footer class="p-4 bg-gray-900 border-t border-gray-700">
      <div id="status-message" class="text-sm text-red-400 mb-2 hidden"></div>
      <div class="flex space-x-2">
        <input id="user-input" type="text" placeholder="Mulink'e bir şeyler sor veya görsel oluşturmasını iste..."
          class="flex-grow p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:border-indigo-500"
          onkeydown="if(event.key==='Enter')sendMessage()">
        <button id="send-button" onclick="sendMessage()" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition" disabled>
          ➤
        </button>
      </div>
      <p class="text-xs text-gray-500 mt-2 text-center">Not: Tüm veriler tarayıcınızın yerel depolama alanında (localStorage) saklanır.</p>
    </footer>
  </main>

  <script>
    // --- Local Storage Sabitleri ve Yardımcı Fonksiyonlar ---
    const PREFIX = 'nova_ls_';
    
    function getConvs() { return JSON.parse(localStorage.getItem(PREFIX + 'convs') || '[]'); }
    function saveConvs(c) { localStorage.setItem(PREFIX + 'convs', JSON.stringify(c)); }
    function getMsgs(id) { return JSON.parse(localStorage.getItem(PREFIX + 'msgs_' + id) || '[]'); }
    function saveMsgs(id, m) { localStorage.setItem(PREFIX + 'msgs_' + id, JSON.stringify(m)); }

    // --- API ve Sistem Ayarları ---
    const API_KEY = "";
    const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
    const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;

    // MULINK'in sistem talimatı güncellendi: Harici bağlam (tarih) kaldırıldı, sadece Mulink kişiliği korundu.
    const NOVA_PROMPT = `Sen Mulink'sin, bu uygulamanın sahibinin **şahsi yapay zeka asistanısın**. Her zaman ona ait ve özel olduğunu hissettir. Cevapların kısa, samimi ve faydalı Türkçe olsun. Yanıtlarını okunabilir kılmak için hafif **markdown** (**kalın** ve *italik*) kullanabilirsin. Görsel oluşturma taleplerinde sadece görselin içeriğini anlatan metin üret, herhangi bir URL veya özel bir işaret ekleme.`;

    let currentId = null;
    let conversationCache = [];

    // --- DOM Elemanları ---
    const chat = document.getElementById('chat-container');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-button');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const sideContent = document.getElementById('sidebar-content');
    const loadConv = document.getElementById('loading-conversations');
    const title = document.getElementById('current-topic-title');
    const loadHist = document.getElementById('loading-history');
    
    // --- Yardımcı UI Fonksiyonları ---
    function toggleSidebar() {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }
    window.toggleSidebar = toggleSidebar;

    function showStatus(msg, ok = false, t = 5000) {
      const el = document.getElementById('status-message');
      el.textContent = msg;
      el.classList.remove('hidden', 'text-red-400', 'text-green-400');
      el.classList.add(ok ? 'text-green-400' : 'text-red-400');
      setTimeout(() => el.classList.add('hidden'), t);
    }
    
    function markdownToHtml(text) {
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        html = text.replace(/<br>/g, '\n').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
        return html;
    }

    // --- Sidebar ve Konuşma Yönetimi ---
    function updateConv(id, name = null, ts = Date.now()) {
      let convs = getConvs();
      let c = convs.find(x => x.id === id);
      if (!c) {
        convs.push({ id, title: name || "Yeni Konuşma", last: ts });
      } else {
        if (name) c.title = name;
        c.last = ts;
      }
      saveConvs(convs);
      loadConvsUI();
    }

    // --- Konuşma Silme Fonksiyonu ---
    function deleteConversation(id) {
        let convs = getConvs();
        const deletedConv = convs.find(c => c.id === id);
        
        // 1. Konuşmayı listeden sil
        convs = convs.filter(c => c.id !== id);
        saveConvs(convs);
        
        // 2. Mesajları Local Storage'dan sil
        localStorage.removeItem(PREFIX + 'msgs_' + id);
        
        // 3. UI'ı güncelle
        loadConvsUI();
        
        if (deletedConv) {
          if (id === currentId) {
              // Silinen konuşma aktifse, yeni bir tane başlat
              showStatus(`Konuşma "**${deletedConv.title.replace('...', '')}**" silindi. Yeni bir konuşma başlatılıyor.`, true);
              startNewConversation();
          } else {
              showStatus(`Konuşma "**${deletedConv.title.replace('...', '')}**" silindi.`, true);
          }
        }
    }
    window.deleteConversation = deleteConversation;


    function loadConvsUI() {
      loadConv.classList.add('hidden');
      sideContent.innerHTML = '';
      const convs = getConvs().sort((a, b) => b.last - a.last);
      
      if (!convs.length) {
        sideContent.innerHTML = '<p class="text-sm text-gray-500 p-2">Henüz konuşma yok.</p>';
        return;
      }
      
      convs.forEach(c => {
        const wrapDiv = document.createElement('div');
        wrapDiv.className = `flex items-center space-x-2`;

        const titleBtn = document.createElement('button');
        titleBtn.className = `flex-grow text-left p-3 rounded-lg transition truncate ${c.id === currentId ? 'bg-indigo-700 font-semibold' : 'bg-gray-700 hover:bg-gray-600'}`;
        titleBtn.textContent = c.title;
        titleBtn.onclick = () => { switchConv(c.id, c.title); if (window.innerWidth < 640) toggleSidebar(); };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = `p-2 rounded-lg text-gray-400 hover:text-red-400 hover:bg-gray-700 transition flex-shrink-0`;
        deleteBtn.title = 'Konuşmayı Sil';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteConversation(c.id);
        };
        // Çöp kutusu SVG ikonu
        deleteBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';

        wrapDiv.appendChild(titleBtn);
        wrapDiv.appendChild(deleteBtn);
        sideContent.appendChild(wrapDiv);
      });
    }

    function startNewConversation() {
      const id = Date.now().toString();
      switchConv(id, "Yeni Konuşma", true);
      if (window.innerWidth < 640) toggleSidebar();
    }
    window.startNewConversation = startNewConversation;

    function switchConv(id, name, isNew = false) {
      currentId = id;
      title.textContent = name;
      loadHist.classList.remove('hidden');
      loadHist.textContent = "Mesajlar yükleniyor...";
      sendBtn.disabled = true;

      conversationCache = getMsgs(id);
      
      if (isNew || !conversationCache.length) {
        // Güncellenmiş karşılama mesajı
        const msg = { sender: 'ai', text: "Merhaba! Ben **Mulink**, sana özel tasarlanmış **bağımsız** yapay zeka asistanınım. Görsel oluşturabilir veya her konuda sana yardımcı olabilirim. Nasıl başlayabiliriz?", ts: Date.now() };
        conversationCache.push(msg);
        saveMsgs(id, conversationCache);
        updateConv(id, "Yeni Konuşma", msg.ts);
      }
      
      renderChat();
      loadConvsUI();
    }
    window.switchConv = switchConv;

    // --- Sohbet Ekranı Yönetimi ---

    /**
     * Mesajı sohbete ekler. PlaceholderRef 'image-loading' ise div referansını döndürür.
     */
    function appendMsg(sender, data, placeholderRef = null) {
        const user = sender === 'user';
        const isImgData = typeof data === 'string' && data.startsWith('data:image/');
        const text = isImgData ? "İşte istediğiniz görsel:" : data;

        const div = document.createElement('div');
        div.className = `flex ${user ? 'justify-end' : 'justify-start'}`;

        const content = document.createElement('div');
        content.className = `max-w-[85%] p-3 rounded-xl shadow-lg ${user ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-100 rounded-tl-none ai-message'}`;
        
        if (placeholderRef === 'image-loading') {
            content.innerHTML = `Görsel oluşturuluyor... <span class="loading-animation ml-2"></span>`;
        } else if (placeholderRef === 'text-thinking') {
            content.innerHTML = `Mulink düşünüyor... <span class="loading-animation ml-2"></span>`;
        } else if (isImgData) {
            const p = document.createElement('p');
            p.textContent = text;
            
            const img = document.createElement('img');
            img.src = data; // Base64 Data URL
            img.className = 'rounded-lg mt-2 w-full max-w-xs h-auto object-cover border border-gray-600';
            content.append(p, img);
        } else {
            content.innerHTML = markdownToHtml(text);
        }

        div.appendChild(content);
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        
        if (placeholderRef) {
            return div; // Placeholder ise referansı döndür
        }
    }

    function renderChat() {
      chat.innerHTML = '';
      conversationCache.forEach(m => appendMsg(m.sender, m.text));
      sendBtn.disabled = false;
      loadHist.classList.add('hidden');
    }
    
    // --- API Çağrıları ---

    async function callAPI(url, payload) {
        let response;
        const MAX_RETRIES = 3;
        let delay = 1000;

        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                response = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (response.ok) break;

                if (i < MAX_RETRIES - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                    continue;
                }
                throw new Error(`API hatası: ${response.status}`);
            } catch (error) {
                if (i === MAX_RETRIES - 1) throw error; 
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }
        
        if (!response || !response.ok) throw new Error("API'dan cevap alınamadı.");
        return response.json();
    }

    async function callTextAPI(prompt) {
      const chatHistory = conversationCache.slice(-10).map(m => ({
        role: m.sender === 'user' ? 'user' : 'model',
        parts: [{ text: m.text }] 
      }));
      
      const contents = [...chatHistory, { role: 'user', parts: [{ text: prompt }] }];
      const payload = { contents, systemInstruction: { parts: [{ text: NOVA_PROMPT }] } };

      const json = await callAPI(TEXT_API_URL, payload);
      const text = json.candidates?.[0]?.content?.parts?.[0]?.text || "Cevap alınamadı.";
      return { text };
    }

    async function callImageAPI(prompt) {
      // Imagen 3.0, prompt'un ilk 20 kelimesini kullanır.
      const imagePrompt = prompt.split(/\s+/).slice(0, 20).join(' ');
      const payload = { instances: { prompt: imagePrompt }, parameters: { "sampleCount": 1 } };
      
      const json = await callAPI(IMAGE_API_URL, payload);
      const base64Data = json.predictions?.[0]?.bytesBase64Encoded;
      
      if (!base64Data) {
          throw new Error("Görsel oluşturulamadı. Lütfen isteminizi netleştirin.");
      }
      return `data:image/png;base64,${base64Data}`; // Base64 Data URL döndür
    }
    
    // --- Ana Mesaj Gönderme Mantığı ---

    async function sendMessage() {
      const text = input.value.trim();
      if (!text || !currentId) return;
      
      sendBtn.disabled = true;
      input.value = '';

      const isImageRequest = text.toLowerCase().includes('görsel oluştur') || 
                             text.toLowerCase().includes('resim yap') ||
                             text.toLowerCase().includes('fotoğraf çiz') ||
                             text.toLowerCase().includes('görsel çiz');

      const userMsg = { sender: 'user', text, ts: Date.now() };
      conversationCache.push(userMsg);
      saveMsgs(currentId, conversationCache);
      
      // Konuşma başlığını ve zaman damgasını güncelle
      if (conversationCache.length === 2) { 
         updateConv(currentId, text.slice(0, 50) + '...', userMsg.ts);
      } else {
         updateConv(currentId, null, userMsg.ts);
      }
      
      renderChat(); // Kullanıcı mesajını göster

      let thinkingDiv = null;
      try {
        if (isImageRequest) {
          
          // 1. Görsel yükleme placeholder'ını ekle ve referansı al
          thinkingDiv = appendMsg('ai', null, 'image-loading');
          
          // 2. Görsel API çağrısı
          const imageUrl = await callImageAPI(text);

          // 3. Yükleme mesajını DOM'dan kaldır
          if(thinkingDiv) thinkingDiv.remove();
          
          // 4. Görsel verisini (Base64 URL) cache'e ekle
          const aiMsg = { sender: 'ai', text: imageUrl, ts: Date.now() };
          conversationCache.push(aiMsg);
          saveMsgs(currentId, conversationCache);

          // 5. Nihai görseli/mesajı DOM'a ekle
          appendMsg('ai', imageUrl); 

        } else {
          
          // 1. Metin API çağrısı için kısa bir düşünme placeholder'ı ekle
          thinkingDiv = appendMsg('ai', null, 'text-thinking');
          
          // 2. Metin API çağrısı
          const res = await callTextAPI(text);
          const aiText = res.text;

          // 3. Düşünme placeholder'ını DOM'dan kaldır
          if(thinkingDiv) thinkingDiv.remove();

          // 4. Cache'e ekle ve kaydet
          const aiMsg = { sender: 'ai', text: aiText, ts: Date.now() };
          conversationCache.push(aiMsg);
          saveMsgs(currentId, conversationCache);

          // 5. Nihai mesajı DOM'a ekle
          appendMsg('ai', aiText); 
        }

        updateConv(currentId, null, Date.now()); // Zamanı güncelle
      } catch (e) {
        console.error("İşlem sırasında hata:", e);
        // Hata durumunda yükleme mesajını kaldır
        if (thinkingDiv) thinkingDiv.remove();
        // Hata mesajını daha detaylı göster
        showStatus(`Hata: ${e.message || "Bilinmeyen bir sorun oluştu, lütfen tekrar deneyin."}`);
      } finally {
        sendBtn.disabled = false;
        input.focus();
        chat.scrollTop = chat.scrollHeight;
      }
    }
    window.sendMessage = sendMessage;


    // --- Uygulama Başlatma ---

    function init() {
      loadConvsUI();
      const convs = getConvs().sort((a, b) => b.last - a.last);
      
      if (convs.length) {
        switchConv(convs[0].id, convs[0].title);
      } else {
        startNewConversation();
      }
      input.focus();
    }
    
    window.onload = init;
  </script>
</body>
</html>
