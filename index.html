<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã‡oklu Sohbet AI AsistanÄ±</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .ai-message {
            background-color: #ffffff;
            border-radius: 0.75rem 0.75rem 0.75rem 0; /* Sol Ã¼st, SaÄŸ Ã¼st, SaÄŸ alt, Sol alt */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            border-radius: 0.75rem 0.75rem 0 0.75rem; /* Sol Ã¼st, SaÄŸ Ã¼st, SaÄŸ alt, Sol alt */
        }
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Tam Ekran GÃ¶rÃ¼ntÃ¼sÃ¼ */
        .full-screen-app {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            display: flex;
        }
    </style>
</head>
<body class="full-screen-app">

    <!-- Sidebar - Sohbet Listesi -->
    <div id="sidebar" class="w-64 bg-gray-900 text-white flex flex-col shadow-xl">
        <div class="p-4 border-b border-gray-700">
            <h2 class="text-2xl font-bold">ðŸ’¬ Sohbetler</h2>
        </div>
        
        <!-- Yeni Sohbet Butonu -->
        <button onclick="startNewChat()" class="m-3 p-3 bg-indigo-600 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
            + Yeni Sohbet BaÅŸlat
        </button>

        <!-- Sohbet Listesi -->
        <div id="chat-list" class="flex-grow overflow-y-auto px-3 space-y-1">
            <!-- Chat list items will be injected here -->
        </div>

    </div>

    <!-- Main Chat Window -->
    <div id="main-chat-window" class="flex-grow flex flex-col bg-gray-50 max-w-full">
        
        <!-- Header -->
        <header class="p-4 bg-white border-b border-gray-200 shadow-md flex justify-between items-center">
            <h1 id="chat-title" class="text-xl font-bold text-gray-800 truncate">Sohbet BaÅŸlÄ±ÄŸÄ± YÃ¼kleniyor...</h1>
            <button id="delete-button" onclick="confirmAndDeleteChat()"
                    class="bg-red-500 text-white p-2 rounded-lg shadow-md hover:bg-red-600 transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-medium disabled:opacity-50">
                Sohbeti Sil
            </button>
        </header>

        <!-- Chat Area -->
        <div id="chat-container" class="chat-container p-6 space-y-4">
            <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200 flex items-center space-x-3 shadow-inner">
            <input type="text" id="user-input" placeholder="Sorunuzu buraya yazÄ±n..."
                   class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                   onkeydown="if(event.key === 'Enter') sendMessage()">
            
            <button id="send-button" onclick="sendMessage()"
                    class="bg-indigo-600 text-white p-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 flex items-center justify-center w-12 h-12">
                <svg id="send-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
                <div id="loading-spinner" class="hidden w-6 h-6 border-3 border-t-3 border-white rounded-full animate-spin"></div>
            </button>
        </div>
        
    </div>

    <script>
        // --- Sabitler ve Global DeÄŸiÅŸkenler ---
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // Yeni depolama anahtarlarÄ±
        const CHATS_META_KEY = 'aiChatMetadata';
        const ACTIVE_CHAT_KEY = 'activeAiChatId';

        // UI Elementleri
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const chatListElement = document.getElementById('chat-list');
        const chatTitleElement = document.getElementById('chat-title');

        // Durum DeÄŸiÅŸkenleri
        let chatsMeta = [];      // TÃ¼m sohbetlerin listesi: [{ id: '...', title: '...' }]
        let activeChatId = null; // Åžu anda aktif olan sohbetin ID'si
        let chatHistory = [];    // Aktif sohbetin mesaj geÃ§miÅŸi
        let isProcessing = false;

        // --- YardÄ±mcÄ± Fonksiyonlar ---

        /**
         * MesajlarÄ± ve kaynaklarÄ± ekrana basar.
         * ... (displayMessage fonksiyonu Ã¶ncekiyle aynÄ±)
         */
        function displayMessage(text, role, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 max-w-3/4 rounded-xl shadow-md whitespace-pre-wrap ${role === 'user' ? 'user-message' : 'ai-message'}`;

            const formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');

            messageBubble.innerHTML = formattedText;

            // KaynaklarÄ± AI mesajÄ±nÄ±n altÄ±na ekle
            if (role === 'ai' && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'mt-3 pt-2 border-t border-gray-200 text-xs text-gray-500 space-y-1';
                sourcesDiv.innerHTML = '<span class="font-semibold text-gray-600">Kaynaklar:</span>';

                sources.forEach((source) => {
                    const link = document.createElement('a');
                    link.href = source.uri;
                    link.target = '_blank';
                    link.className = 'block hover:text-indigo-600 truncate';
                    link.textContent = `â€¢ ${source.title || source.uri}`;
                    sourcesDiv.appendChild(link);
                });
                messageBubble.appendChild(sourcesDiv);
            }

            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * UI durumunu (gÃ¶nder/yÃ¼kleniyor) gÃ¼nceller.
         */
        function setUILoading(loading) {
            isProcessing = loading;
            userInput.disabled = loading;
            sendButton.disabled = loading;
            if (loading) {
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
        
        // --- Ã‡oklu Sohbet YÃ¶netimi FonksiyonlarÄ± ---

        /**
         * Yeni benzersiz bir sohbet kimliÄŸi (ID) oluÅŸturur.
         */
        function generateChatId() {
            return 'chat_' + Date.now() + Math.random().toString(16).substring(2, 8);
        }

        /**
         * TÃ¼m sohbet meta verilerini (ID, BaÅŸlÄ±k) localStorage'dan yÃ¼kler.
         */
        function loadChatsMeta() {
            try {
                const storedMeta = localStorage.getItem(CHATS_META_KEY);
                chatsMeta = storedMeta ? JSON.parse(storedMeta) : [];
                activeChatId = localStorage.getItem(ACTIVE_CHAT_KEY);
            } catch (error) {
                console.error("Meta veri yÃ¼klenirken hata:", error);
                chatsMeta = [];
                activeChatId = null;
            }
        }

        /**
         * TÃ¼m sohbet meta verilerini (ID, BaÅŸlÄ±k) localStorage'a kaydeder.
         */
        function saveChatsMeta() {
            localStorage.setItem(CHATS_META_KEY, JSON.stringify(chatsMeta));
            if (activeChatId) {
                localStorage.setItem(ACTIVE_CHAT_KEY, activeChatId);
            } else {
                localStorage.removeItem(ACTIVE_CHAT_KEY);
            }
        }

        /**
         * Belirli bir sohbet geÃ§miÅŸini yÃ¼kler.
         */
        function loadChatHistory(chatId) {
            try {
                const storedHistory = localStorage.getItem(chatId);
                chatHistory = storedHistory ? JSON.parse(storedHistory) : [];
                return chatHistory;
            } catch (error) {
                console.error(`Sohbet geÃ§miÅŸi (${chatId}) yÃ¼klenirken hata:`, error);
                return [];
            }
        }

        /**
         * Aktif sohbet geÃ§miÅŸini kaydeder.
         */
        function saveActiveChatHistory() {
            if (activeChatId && chatHistory.length > 0) {
                localStorage.setItem(activeChatId, JSON.stringify(chatHistory));
            }
            
            // Ä°lk mesajÄ± kullanarak baÅŸlÄ±k oluÅŸtur ve meta veriyi gÃ¼ncelle
            const firstUserMessage = chatHistory.find(msg => msg.role === 'user');
            if (firstUserMessage) {
                const newTitle = firstUserMessage.parts[0].text.substring(0, 30) + '...';
                let chatMeta = chatsMeta.find(meta => meta.id === activeChatId);

                if (chatMeta) {
                    chatMeta.title = newTitle;
                } else {
                    // Bu, startNewChat tarafÄ±ndan yapÄ±lmalÄ±ydÄ±, ama garanti olsun.
                    chatsMeta.push({ id: activeChatId, title: newTitle });
                }
                saveChatsMeta();
            }
            renderChatList();
        }

        /**
         * Belirtilen sohbete geÃ§er ve UI'Ä± gÃ¼nceller.
         */
        function switchChat(chatId) {
            if (isProcessing) {
                // ModalsÄ±z uyarÄ±
                alert("LÃ¼tfen Ã¶nceki iÅŸlemin bitmesini bekleyin.");
                return;
            }
            
            // Mevcut sohbeti kaydet (eÄŸer varsa)
            if (activeChatId) {
                saveActiveChatHistory();
            }

            activeChatId = chatId;
            
            // Yeni sohbet geÃ§miÅŸini yÃ¼kle
            chatHistory = loadChatHistory(chatId);
            
            // UI'Ä± temizle ve yeni geÃ§miÅŸi gÃ¶rÃ¼ntÃ¼le
            chatContainer.innerHTML = '';
            chatHistory.forEach(msg => {
                const text = msg.parts[0].text;
                const sources = msg.sources || [];
                displayMessage(text, msg.role, sources);
            });
            
            // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
            const chatMeta = chatsMeta.find(meta => meta.id === chatId);
            chatTitleElement.textContent = chatMeta ? chatMeta.title : 'Yeni Sohbet';
            
            // Sidebar'daki aktifliÄŸi iÅŸaretle
            document.querySelectorAll('.chat-item').forEach(el => {
                el.classList.remove('bg-indigo-700');
                if (el.dataset.chatId === chatId) {
                    el.classList.add('bg-indigo-700');
                }
            });

            saveChatsMeta(); // Aktif sohbet ID'sini kaydet
            userInput.focus();
        }

        /**
         * Yeni bir sohbet oturumu baÅŸlatÄ±r.
         */
        function startNewChat() {
            // Mevcut sohbeti kaydet
            if (activeChatId) {
                saveActiveChatHistory();
            }

            const newId = generateChatId();
            const newMeta = { id: newId, title: 'Yeni Sohbet', timestamp: Date.now() };

            chatsMeta.unshift(newMeta); // En Ã¼ste ekle
            saveChatsMeta();
            
            // Yeni sohbete geÃ§
            switchChat(newId);
        }

        /**
         * Sidebar'daki sohbet listesini yeniden oluÅŸturur.
         */
        function renderChatList() {
            chatListElement.innerHTML = '';
            
            // En son ekleneni veya gÃ¼ncelleneni Ã¼ste taÅŸÄ±mak iÃ§in sÄ±ralama yapabiliriz.
            chatsMeta.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (chatsMeta.length === 0) {
                 // Ä°lk Ã§alÄ±ÅŸtÄ±rmada veya tÃ¼mÃ¼ silindiÄŸinde yeni bir sohbet baÅŸlat.
                 startNewChat(); 
                 return; 
            }

            chatsMeta.forEach(meta => {
                const item = document.createElement('div');
                item.className = `chat-item p-3 rounded-lg cursor-pointer hover:bg-gray-800 transition duration-100 truncate ${meta.id === activeChatId ? 'bg-indigo-700' : ''}`;
                item.textContent = meta.title;
                item.dataset.chatId = meta.id;
                item.onclick = () => switchChat(meta.id);
                chatListElement.appendChild(item);
            });
        }
        
        /**
         * Sohbeti silmeyi onaylar ve iÅŸlemi gerÃ§ekleÅŸtirir.
         */
        function confirmAndDeleteChat() {
            // ModalsÄ±z onay iÃ§in geÃ§ici uyarÄ±
            if (!activeChatId) return;

            const chatMeta = chatsMeta.find(meta => meta.id === activeChatId);
            const title = chatMeta ? chatMeta.title : 'Bu Sohbeti';
            
            if (confirm(`${title} silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`)) {
                deleteChat(activeChatId);
            }
        }
        
        /**
         * Belirtilen sohbeti tamamen siler.
         */
        function deleteChat(chatIdToDelete) {
            // 1. localStorage'dan geÃ§miÅŸi sil
            localStorage.removeItem(chatIdToDelete);

            // 2. Meta veriden kaldÄ±r
            const index = chatsMeta.findIndex(meta => meta.id === chatIdToDelete);
            if (index > -1) {
                chatsMeta.splice(index, 1);
            }
            saveChatsMeta();

            // 3. Aktif sohbeti kontrol et ve yÃ¶nlendir
            if (chatIdToDelete === activeChatId) {
                if (chatsMeta.length > 0) {
                    // Kalan son sohbete geÃ§
                    switchChat(chatsMeta[0].id);
                } else {
                    // BaÅŸka sohbet yoksa yeni bir tane baÅŸlat
                    startNewChat();
                }
            } else {
                // Sadece listeyi yeniden render et
                renderChatList();
            }
        }
        

        // --- Gemini API Ã‡aÄŸrÄ±sÄ± (Ã–ncekiyle aynÄ±, geÃ§miÅŸ entegrasyonu hariÃ§) ---
        
        async function getGeminiResponse(userQuery) {
            const systemPrompt = "Sen, kullanÄ±cÄ±nÄ±n sorularÄ±na TÃ¼rkÃ§e olarak doÄŸru, gÃ¼ncel ve ayrÄ±ntÄ±lÄ± cevaplar veren, profesyonel bir yapay zeka asistanÄ±sÄ±n. YanÄ±tlarÄ±nÄ± verirken her zaman Google Arama sonuÃ§larÄ±nÄ± kullan ve Markdown formatÄ±nÄ± koru.";
            
            // Mevcut sohbet geÃ§miÅŸini (sadece role ve parts) API'a gÃ¶nder
            const conversationHistoryForApi = chatHistory.map(msg => ({
                role: msg.role, 
                parts: msg.parts // { text: "..." }
            }));
            
            // KullanÄ±cÄ± sorgusunu geÃ§miÅŸin sonuna ekle
            conversationHistoryForApi.push({ role: 'user', parts: [{ text: userQuery }] });

            const payload = {
                contents: conversationHistoryForApi, // TÃ¼m geÃ§miÅŸi gÃ¶nder
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 5;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                        continue;
                    }

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API HatasÄ±: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        return { text, sources };

                    } else {
                        return { text: "ÃœzgÃ¼nÃ¼m, geÃ§erli bir yanÄ±t alamadÄ±m.", sources: [] };
                    }
                } catch (error) {
                    console.error("API Ã§aÄŸrÄ±sÄ± sÄ±rasÄ±nda hata:", error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                    } else {
                        throw new Error(`Yapay Zeka ile iletiÅŸim kurulamadÄ±: ${error.message}`);
                    }
                }
            }
        }


        // --- Ana Ä°ÅŸlem Fonksiyonu ---

        async function sendMessage() {
            const query = userInput.value.trim();
            if (!query || isProcessing || !activeChatId) return;

            // EÄŸer bu yeni bir sohbetteki ilk mesajsa, baÅŸlÄ±ÄŸÄ± ayarla
            if (chatHistory.length === 0) {
                 const newTitle = query.substring(0, 30) + '...';
                 const metaIndex = chatsMeta.findIndex(meta => meta.id === activeChatId);
                 if (metaIndex > -1) {
                    chatsMeta[metaIndex].title = newTitle;
                    chatsMeta[metaIndex].timestamp = Date.now(); // En Ã¼ste Ã§Ä±karmak iÃ§in zaman damgasÄ±
                 }
                 chatTitleElement.textContent = newTitle;
                 saveChatsMeta();
                 renderChatList();
            }

            // 1. UI'Ä± HazÄ±rla
            userInput.value = '';
            setUILoading(true);

            // 2. KullanÄ±cÄ± MesajÄ±nÄ± GÃ¶rÃ¼ntÃ¼le ve GeÃ§miÅŸe Ekle
            displayMessage(query, 'user');
            chatHistory.push({ role: 'user', parts: [{ text: query }] });
            saveActiveChatHistory();

            try {
                // 3. API'dan YanÄ±tÄ± Al
                const { text: aiResponseText, sources: aiSources } = await getGeminiResponse(query);
                
                // 4. AI MesajÄ±nÄ± GÃ¶rÃ¼ntÃ¼le ve GeÃ§miÅŸe Ekle
                displayMessage(aiResponseText, 'ai', aiSources);
                
                chatHistory.push({ 
                    role: 'ai', 
                    parts: [{ text: aiResponseText }], 
                    sources: aiSources 
                });
                
                // YanÄ±t geldikten sonra tekrar kaydet
                saveActiveChatHistory();

            } catch (error) {
                displayMessage(`Hata oluÅŸtu: ${error.message}`, 'ai');
            } finally {
                // 5. UI'Ä± SÄ±fÄ±rla
                setUILoading(false);
            }
        }

        // --- BaÅŸlangÄ±Ã§ ---
        window.onload = function() {
            loadChatsMeta();
            
            if (!activeChatId || chatsMeta.length === 0) {
                // Ä°lk Ã§alÄ±ÅŸtÄ±rma veya geÃ§miÅŸi silinmiÅŸ
                startNewChat();
            } else {
                // Daha Ã¶nce kalmÄ±ÅŸ aktif sohbete geÃ§
                switchChat(activeChatId);
            }
            renderChatList();
            userInput.focus();
        };

    </script>
</body>
</html>
