<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MuAi - Çoklu Sohbet Asistanı</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* CSS'i yan menünün her zaman açık kalmaması için güncelledim. */
body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
.ai-message { background-color: #fff; border-radius: 0.75rem 0.75rem 0.75rem 0; box-shadow:0 2px 4px rgba(0,0,0,0.05); border:1px solid #e5e7eb; max-width: 80%; }
.user-message { background-color: #3b82f6; color:white; border-radius:0.75rem 0.75rem 0 0.75rem; max-width: 80%;}
.chat-container { flex-grow:1; overflow-y:auto; scroll-behavior:smooth; }
.full-screen-app { height:100vh; width:100vw; margin:0; padding:0; display:flex; position:relative;}
/* Sidebar artık sadece mobil değil, her zaman hareketli (absolute) olacak */
#sidebar { transition: transform 0.3s ease-in-out; position:absolute; height:100%; z-index:50; }

.tts-spinner { border:4px solid rgba(255,255,255,0.3); border-top:4px solid #fff; border-radius:50%; width:16px; height:16px; animation:spin 1s linear infinite; }
@keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

/* Yazıyor... Göstergesi Animasyonu */
.typing-dots .dot {
    animation: bounce 1.4s infinite ease-in-out both;
}
.typing-dots .dot:nth-child(2) { animation-delay: -0.32s; }
.typing-dots .dot:nth-child(3) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1.0); }
}

/* Masaüstünde sidebar'ın görünürlüğü artık sadece toggle butonuna bağlı */
@media (min-width: 768px) {
    #main-chat-window {
        padding-left: 0;
    }
}
</style>
</head>
<body class="full-screen-app">

<!-- Sidebar: Artık md:translate-x-0 yok, her zaman toggle edilebilir. -->
<div id="sidebar" class="w-64 bg-gray-900 text-white flex flex-col shadow-xl -translate-x-full">
<div class="p-4 border-b border-gray-700 flex items-center justify-between">
    <h2 class="text-2xl font-bold">MuAi Sohbetler</h2>
</div>
<button onclick="startNewChat(); toggleSidebar(true)" class="m-3 p-3 bg-indigo-600 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">+ Yeni Sohbet Başlat</button>
<div id="chat-list" class="flex-grow overflow-y-auto px-3 space-y-1"></div>
</div>

<div id="main-chat-window" class="flex-grow flex flex-col bg-gray-50 max-w-full w-full">
<header class="p-4 bg-white border-b border-gray-200 shadow-md flex items-center">
<!-- Menü düğmesi artık her zaman görünür -->
<button id="menu-toggle" onclick="toggleSidebar()" class="p-2 mr-4 text-gray-600 hover:text-indigo-600 focus:outline-none">
<svg id="menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
<svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
</button>
<h1 id="chat-title" class="text-xl font-bold text-gray-800 truncate flex-grow">MuAi Asistanı</h1>
<button id="summarize-button" onclick="summarizeChat()" class="ml-4 p-2 bg-purple-500 text-white rounded-lg shadow-md hover:bg-purple-600 transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm font-medium disabled:opacity-50 flex items-center">
<span id="summarize-text">Özetle ✨</span>
<div id="summarize-spinner" class="tts-spinner hidden ml-2 border-t-white"></div>
</button>
<button id="tts-button" onclick="speakLastAiMessage()" class="ml-2 p-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-150 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm font-medium disabled:opacity-50 flex items-center">
<span id="tts-text">Seslendir 🔊</span>
<div id="tts-spinner" class="tts-spinner hidden ml-2 border-t-white"></div>
</button>
<button id="delete-button" onclick="confirmAndDeleteChat()" class="bg-red-500 text-white p-2 ml-4 rounded-lg shadow-md hover:bg-red-600 transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-medium disabled:opacity-50">Sohbeti Sil</button>
</header>

<div id="chat-container" class="chat-container p-6 space-y-4"></div>

<!-- Yazıyor... Göstergesi (Küçük Yumru) -->
<div id="typing-indicator-container" class="hidden p-4 flex items-center space-x-2">
    <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><circle cx="12" cy="12" r="1" fill="currentColor"/><circle cx="8" cy="12" r="1" fill="currentColor"/><circle cx="16" cy="12" r="1" fill="currentColor"/></svg>
    </div>
    <div class="ai-message p-3 flex items-center space-x-2">
        <span class="text-gray-700">Asistan yazıyor</span>
        <div class="typing-dots flex space-x-1">
            <div class="w-2 h-2 bg-indigo-500 rounded-full dot"></div>
            <div class="w-2 h-2 bg-indigo-500 rounded-full dot"></div>
            <div class="w-2 h-2 bg-indigo-500 rounded-full dot"></div>
        </div>
    </div>
</div>

<div class="p-4 bg-white border-t border-gray-200 flex items-center space-x-3 shadow-inner">
<input type="text" id="user-input" placeholder="Sorunuzu buraya yazın..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150" onkeydown="if(event.key==='Enter') sendMessage()">
<button id="send-button" onclick="sendMessage()" class="bg-indigo-600 text-white p-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 flex items-center justify-center w-12 h-12">
<svg id="send-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
<div id="loading-spinner" class="hidden w-6 h-6 border-3 border-t-3 border-white rounded-full animate-spin"></div>
</button>
</div>
</div>

<div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center">
<div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
<h3 class="text-lg font-bold mb-4 text-gray-800">İşlem Onayı</h3>
<p id="modal-message" class="mb-6 text-gray-700"></p>
<div class="flex justify-end space-x-3">
<button onclick="hideModal(false)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">İptal</button>
<button id="modal-confirm-button" onclick="hideModal(true)" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">Onayla</button>
</div>
</div>
</div>

<audio id="tts-audio" style="display:none;"></audio>

<script>
// --- Sabitler ve Global Durum ---
// ** DİKKAT: API_KEY BOŞ KALMALIDIR. Sistem otomatik sağlar. **
const API_KEY = "AIzaSyC5TjJMwl_kjTF9unQbpik5exA8WDn0_Bk"; 
const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

// Local Storage Anahtarları 
const CHATS_META_KEY = 'AI_CHAT_META_V1';
const ACTIVE_CHAT_KEY = 'AI_ACTIVE_CHAT_ID_V1';

// UI elementleri
const chatContainer = document.getElementById('chat-container');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const sendIcon = document.getElementById('send-icon');
const loadingSpinner = document.getElementById('loading-spinner');
const chatListElement = document.getElementById('chat-list');
const chatTitleElement = document.getElementById('chat-title');
const sidebar = document.getElementById('sidebar');
const menuIcon = document.getElementById('menu-icon');
const closeIcon = document.getElementById('close-icon');
const summarizeButton = document.getElementById('summarize-button');
const summarizeSpinner = document.getElementById('summarize-spinner');
const summarizeText = document.getElementById('summarize-text');
const ttsButton = document.getElementById('tts-button');
const ttsSpinner = document.getElementById('tts-spinner');
const ttsText = document.getElementById('tts-text');
const ttsAudio = document.getElementById('tts-audio');
const typingIndicator = document.getElementById('typing-indicator-container');

const confirmationModal = document.getElementById('confirmation-modal');
const modalMessage = document.getElementById('modal-message');
const modalConfirmButton = document.getElementById('modal-confirm-button');
let modalCallback = null;

// Durum Değişkenleri
let chatsMeta = []; 
let activeChatId = null;
let chatHistory = []; 
let isProcessing = false;
let isTtsProcessing = false;
let isSummarizing = false;

// --- Local Storage Fonksiyonları ---

function loadData() {
    try {
        const metaJson = localStorage.getItem(CHATS_META_KEY);
        chatsMeta = metaJson ? JSON.parse(metaJson) : [];
        
        chatsMeta.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));

        const activeId = localStorage.getItem(ACTIVE_CHAT_KEY);
        
        if (activeId && chatsMeta.some(c => c.id === activeId)) {
            activeChatId = activeId;
        } else if (chatsMeta.length > 0) {
            activeChatId = chatsMeta[0].id;
        } else {
            activeChatId = null;
        }
    } catch (e) {
        console.error("Local Storage'dan veri yüklenemedi.", e);
        chatsMeta = [];
        activeChatId = null;
    }
}

function saveData() {
    try {
        chatsMeta.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
        localStorage.setItem(CHATS_META_KEY, JSON.stringify(chatsMeta));
        if (activeChatId) {
            localStorage.setItem(ACTIVE_CHAT_KEY, activeChatId);
        }
    } catch (e) {
        console.error("Local Storage'a veri kaydedilemedi.", e);
    }
}

function loadHistory(chatId) {
    if (!chatId) {
        chatHistory = [];
        return;
    }
    try {
        const historyJson = localStorage.getItem(`AI_CHAT_HISTORY_${chatId}`);
        chatHistory = historyJson ? JSON.parse(historyJson) : [];
    } catch (e) {
        console.error(`Local Storage'dan sohbet geçmişi (${chatId}) yüklenemedi.`, e);
        chatHistory = [];
    }
}

function saveHistory(chatId, history) {
    if (!chatId) return;
    try {
        localStorage.setItem(`AI_CHAT_HISTORY_${chatId}`, JSON.stringify(history));
    } catch (e) {
        console.error(`Local Storage'a sohbet geçmişi (${chatId}) kaydedilemedi.`, e);
    }
}

async function deleteChatData(chatId) {
    if (!chatId) return;
    try {
        localStorage.removeItem(`AI_CHAT_HISTORY_${chatId}`);
        
        chatsMeta = chatsMeta.filter(c => c.id !== chatId);
        saveData();
    } catch (e) {
        console.error("Sohbet verisi Local Storage'dan silinemedi.", e);
    }
}

// --- Yardımcı Fonksiyonlar ve UI Güncellemeleri ---

function renderChatList() {
    chatListElement.innerHTML = '';
    
    if (chatsMeta.length === 0) {
        chatListElement.innerHTML = '<p class="text-gray-500 p-3 text-center">Henüz sohbet yok. Yeni bir sohbet başlatın!</p>';
        return;
    }

    chatsMeta.forEach(chat => {
        const isActive = chat.id === activeChatId;
        const button = document.createElement('button');
        button.className = `w-full text-left p-3 rounded-lg truncate transition duration-150 ${isActive ? 'bg-indigo-700 text-white font-semibold' : 'text-gray-300 hover:bg-gray-700'}`;
        button.textContent = chat.title || 'Adsız Sohbet';
        button.onclick = () => {
            switchChat(chat.id);
            // Mobil cihazlarda otomatik kapat
            if (window.innerWidth < 768) {
                toggleSidebar(true);
            }
        };
        chatListElement.appendChild(button);
    });

    // Başlığı güncelle
    const activeMeta = chatsMeta.find(c => c.id === activeChatId);
    chatTitleElement.textContent = activeMeta ? activeMeta.title : 'MuAi Asistanı';
}

function displayMessage(text, role) {
    const messageWrapper = document.createElement('div');
    const isUser = role === 'user';
    const alignClass = isUser ? 'flex justify-end' : 'flex justify-start';

    // Markdown'ı temel HTML'e dönüştür
    let formattedText = text;
    formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
    formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
    formattedText = formattedText.replace(/^- (.*)/gm, '<li>$1</li>');

    // Düzeltilmiş: Mesajı her zaman sohbet kapsayıcısının sonuna ekle
    chatContainer.appendChild(messageWrapper); 
    
    const messageBox = document.createElement('div');
    messageBox.className = `p-4 text-sm ${isUser ? 'user-message' : 'ai-message'} break-words`;
    messageBox.innerHTML = formattedText.trim();

    messageWrapper.className = alignClass;
    messageWrapper.appendChild(messageBox);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function setUILoading(loading) {
    isProcessing = loading;
    userInput.disabled = loading;
    sendButton.disabled = loading;

    if (loading) {
        sendIcon.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');
    } else {
        sendIcon.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
    }
    summarizeButton.disabled = loading || isTtsProcessing || isSummarizing;
    ttsButton.disabled = loading || isTtsProcessing || isSummarizing;
    document.getElementById('delete-button').disabled = loading;
}

function setSummarizeLoading(loading) {
    isSummarizing = loading;
    summarizeButton.disabled = loading || isProcessing || isTtsProcessing;
    if (loading) {
        summarizeText.classList.add('hidden');
        summarizeSpinner.classList.remove('hidden');
        summarizeButton.title = "Özetleniyor...";
    } else {
        summarizeText.classList.remove('hidden');
        summarizeSpinner.classList.add('hidden');
        summarizeButton.title = "Sohbeti Özetle";
    }
}

function setTtsLoading(loading) {
    isTtsProcessing = loading;
    ttsButton.disabled = loading || isProcessing || isSummarizing;
    if (loading) {
        ttsText.classList.add('hidden');
        ttsSpinner.classList.remove('hidden');
        ttsButton.title = "Seslendiriliyor...";
    } else {
        ttsText.classList.remove('hidden');
        ttsSpinner.classList.add('hidden');
        ttsButton.title = "Son Yanıtı Seslendir";
    }
}

function generateChatId() {
    return crypto.randomUUID();
}

/**
 * Sidebar'ı açar/kapatır (her ekranda çalışır).
 */
window.toggleSidebar = function(forceClose = false) {
    const isCurrentlyOpen = !sidebar.classList.contains('-translate-x-full');

    if (forceClose || isCurrentlyOpen) {
        sidebar.classList.add('-translate-x-full');
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
    } else {
        sidebar.classList.remove('-translate-x-full');
        menuIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
    }
};

function showModal(message, confirmText, callback) {
    modalMessage.textContent = message;
    modalConfirmButton.textContent = confirmText;
    modalCallback = callback;
    confirmationModal.classList.remove('hidden');
}

window.hideModal = function(confirmed) {
    confirmationModal.classList.add('hidden');
    if (confirmed && modalCallback) {
        modalCallback();
    }
    modalCallback = null;
}

window.confirmAndDeleteChat = function() {
    if (!activeChatId) return;

    const chat = chatsMeta.find(c => c.id === activeChatId);
    const title = chat ? chat.title : 'Bu Sohbeti';
    
    showModal(`"${title}" başlıklı sohbeti kalıcı olarak silmek istediğinizden emin misiniz?`, 'SİL', async () => {
        const deletedChatId = activeChatId;
        await deleteChatData(deletedChatId); 
        
        loadData(); 
        
        if (chatsMeta.length > 0) {
            switchChat(chatsMeta[0].id);
        } else {
            startNewChat();
        }
        renderChatList();
    });
}

window.startNewChat = async function() {
    const newChatId = generateChatId();
    activeChatId = newChatId;
    chatHistory = [];
    
    const newChatMeta = {
        id: newChatId,
        title: 'Yeni Sohbet (MuAi)', 
        lastUpdated: Date.now()
    };

    chatsMeta.push(newChatMeta);
    saveData();
    saveHistory(newChatId, chatHistory); 

    chatContainer.innerHTML = '';
    chatTitleElement.textContent = newChatMeta.title;
    userInput.focus();
    renderChatList(); 

    // MuAi karşılama mesajı
    displayMessage("Merhaba! Ben Gemini tabanlı çoklu sohbet asistanınız **MuAi**. Nasıl yardımcı olabilirim?", "model");
}

window.switchChat = async function(chatId) {
    if (activeChatId === chatId) return;
    
    saveHistory(activeChatId, chatHistory); 

    activeChatId = chatId;
    chatContainer.innerHTML = '';
    setUILoading(true);

    loadHistory(chatId);
    
    if (chatHistory.length === 0) {
        displayMessage("Merhaba! Yeni sohbete hoş geldiniz. Sorunuzu sorabilirsiniz.", "model");
    } else {
        chatHistory.forEach(message => {
            if (message.parts && message.parts[0] && message.parts[0].text) {
                displayMessage(message.parts[0].text, message.role);
            }
        });
    }

    setUILoading(false);
    renderChatList();
}

// --- API ve Mesajlaşma Fonksiyonları ---

async function getGeminiResponse(prompt, history) {
    const chatHistoryForApi = [...history]; 

    const systemInstruction = "Sen, Türkiye'den bir kullanıcıya destek veren, samimi, kibar ve çok yönlü bir yapay zeka asistanı olan MuAi'sin. Yanıtlarını Türkçe ve anlaşılır bir dille, markdown formatında vermelisin. Yanıtların 500 kelimeyi geçmemelidir. Akademik konular dışında teknik olmayan, samimi bir ton kullan.";
    
    chatHistoryForApi.push({ role: "user", parts: [{ text: prompt }] });

    const payload = {
        contents: chatHistoryForApi,
        tools: [{ "google_search": {} }],
        systemInstruction: {
            parts: [{ text: systemInstruction }]
        },
    };

    let response = null;
    let attempts = 0;
    const maxRetries = 5;

    while (attempts < maxRetries) {
        attempts++;
        try {
            const fetchResponse = await fetch(TEXT_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (fetchResponse.ok) {
                response = await fetchResponse.json();
                break; 
            } else if (fetchResponse.status === 429 && attempts < maxRetries) {
                const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
                console.warn(`Rate limit uyarısı (429). ${delay}ms bekleyip tekrar deneniyor...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                // API'dan HTTP hata kodu gelirse (400, 500 vb.) hata fırlat
                const status = fetchResponse.status;
                const statusText = fetchResponse.statusText;
                const errorBody = await fetchResponse.text();
                
                // HATA DETAYINI KONSOLA LOGLAMA
                console.error(`MUAI HATA DETAY: HTTP Status ${status} - ${statusText}. Yanıt gövdesi:`, errorBody.substring(0, 500));
                
                throw new Error(`API HTTP Hatası: ${status} - ${statusText}. (Detaylar Konsolda)`);
            }
        } catch (error) {
            console.error("API çağrısı sırasında genel hata:", error.message || error);
            if (attempts === maxRetries) throw error; // Maksimum denemeden sonra hatayı fırlat
        }
    }

    return response;
}

window.sendMessage = async function() {
    if (isProcessing) return;

    const prompt = userInput.value.trim();
    if (!prompt) return;

    userInput.value = '';
    displayMessage(prompt, 'user');
    setUILoading(true);

    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

    typingIndicator.classList.remove('hidden');
    chatContainer.scrollTop = chatContainer.scrollHeight;

    try {
        const apiResponse = await getGeminiResponse(prompt, chatHistory);

        const text = apiResponse?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (text) {
            displayMessage(text, 'model');
            chatHistory.push({ role: "model", parts: [{ text: text }] });

            if (chatHistory.length === 2) { 
                await generateTitleFromFirstMessage(prompt);
            } 
            
            saveHistory(activeChatId, chatHistory);
            const chatIndex = chatsMeta.findIndex(c => c.id === activeChatId);
            if(chatIndex !== -1) {
                chatsMeta[chatIndex].lastUpdated = Date.now();
                saveData();
            }
        } else {
            // API yanıt verdi ancak içerik beklenmiyor veya boş geldi.
            console.error("API'dan geçerli metin alınamadı. Yanıt yapısı bozuk olabilir.", { apiResponse, chatHistory });
            const errorMsg = "Üzgünüm, yanıt alınamadı veya yapısal bir sorun oluştu. Lütfen konsolu kontrol edin.";
            displayMessage(errorMsg, 'model');
            chatHistory.push({ role: "model", parts: [{ text: errorMsg }] });
            saveHistory(activeChatId, chatHistory);
        }

    } catch (error) {
        // Ağ hatası veya getGeminiResponse içinden fırlatılan hata
        console.error("Mesaj gönderme hatası (Detay):", error.message || error);
        console.error("Tam Hata Objesi:", error);
        displayMessage("Bir bağlantı veya işlem hatası oluştu. Konsolu kontrol ediniz.", 'model');
        
        // Hata mesajını history'e ekle (opsiyonel)
        chatHistory.push({ role: "model", parts: [{ text: "İşlem sırasında kritik hata oluştu." }] });
        saveHistory(activeChatId, chatHistory);
        
    } finally {
        typingIndicator.classList.add('hidden'); 
        setUILoading(false);
        userInput.focus();
    }
}

async function generateTitleFromFirstMessage(firstPrompt) {
    if (!activeChatId) return;

    const titlePrompt = `Aşağıdaki ilk sohbet mesajına dayanarak, 5 kelimeyi geçmeyen, ilgi çekici ve özet bir başlık önerin. Yalnızca başlığı döndürün, başka hiçbir şey söylemeyin: "${firstPrompt}"`;

    try {
        const response = await getGeminiResponse(titlePrompt, []); 
        const title = response?.candidates?.[0]?.content?.parts?.[0]?.text.trim().replace(/['"]+/g, '');

        const chatIndex = chatsMeta.findIndex(c => c.id === activeChatId);
        if (chatIndex !== -1) {
            const shortTitle = title && title.length > 3 ? (title.length > 30 ? title.substring(0, 27) + '...' : title) : 'Adsız Sohbet';
            
            chatsMeta[chatIndex].title = shortTitle;
            chatsMeta[chatIndex].lastUpdated = Date.now();
            saveData();
            
            chatTitleElement.textContent = shortTitle;
            renderChatList(); 
        }

    } catch (error) {
        // Başlık oluşturma hatası için detaylı loglama
        console.error("Başlık oluşturulamadı (Detay):", error.message || error);
        
        // Hata durumunda varsayılan başlık kullan
        const chatIndex = chatsMeta.findIndex(c => c.id === activeChatId);
        if (chatIndex !== -1) {
            chatsMeta[chatIndex].title = 'Adsız Sohbet';
            chatsMeta[chatIndex].lastUpdated = Date.now();
            saveData();
        }
        renderChatList();
    }
}

window.summarizeChat = async function() {
    if (chatHistory.length < 2 || isProcessing || isSummarizing) return;
    
    setSummarizeLoading(true);

    const historyText = chatHistory
        .filter(m => m.parts && m.parts[0] && m.parts[0].text)
        .map(m => `${m.role === 'user' ? 'Kullanıcı' : 'Asistan'}: ${m.parts[0].text}`)
        .join('\n\n');

    const prompt = `Aşağıdaki tüm sohbet geçmişini, temel konuları ve kararları içeren tek bir paragrafla, resmi olmayan bir dille Türkçe olarak özetleyin:\n\n---\n\n${historyText}`;

    try {
        const apiResponse = await getGeminiResponse(prompt, []); 
        const summaryText = apiResponse?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (summaryText) {
            showModal("Sohbet Özeti", summaryText, () => hideModal(false));
        } else {
            showModal("Özetleme Hatası", "Üzgünüm, sohbet özetlenemedi. Lütfen tekrar deneyin.", () => hideModal(false));
        }
    } catch (error) {
        console.error("Özetleme hatası:", error);
        showModal("Bağlantı Hatası", "API ile bağlantı kurulurken bir sorun oluştu.", () => hideModal(false));
    } finally {
        setSummarizeLoading(false);
    }
}

// --- TTS Fonksiyonları ---

function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

function pcmToWav(pcm16, sampleRate) {
    const dataView = new DataView(new ArrayBuffer(44 + pcm16.length * 2));
    let offset = 0;

    function writeString(s) {
        for (let i = 0; i < s.length; i++) {
            dataView.setUint8(offset + i, s.charCodeAt(i));
        }
        offset += s.length;
    }

    function writeUint32(i) {
        dataView.setUint32(offset, i, true);
        offset += 4;
    }

    function writeUint16(i) {
        dataView.setUint16(offset, i, true);
        offset += 2;
    }

    // RIFF header
    writeString('RIFF');
    writeUint32(36 + pcm16.length * 2); 
    writeString('WAVE');

    // FMT sub-chunk
    writeString('fmt ');
    writeUint32(16); 
    writeUint16(1);  
    writeUint16(1);  
    writeUint32(sampleRate);
    writeUint32(sampleRate * 2); 
    writeUint16(2);  
    writeUint16(16); 

    // Data sub-chunk
    writeString('data');
    writeUint32(pcm16.length * 2); 

    // PCM verisini yaz
    for (let i = 0; i < pcm16.length; i++) {
        dataView.setInt16(offset, pcm16[i], true);
        offset += 2;
    }

    return new Blob([dataView.buffer], { type: 'audio/wav' });
}


window.speakLastAiMessage = async function() {
    if (isProcessing || isTtsProcessing) return;

    const lastAiMessage = chatHistory.slice().reverse().find(m => m.role === 'model' && m.parts?.[0]?.text)?.parts?.[0]?.text;
    
    if (!lastAiMessage) {
        showModal("Seslendirme Hatası", "Seslendirilecek bir yapay zeka yanıtı bulunamadı.", 'Tamam');
        return;
    }

    setTtsLoading(true);

    try {
        const payload = {
            contents: [{ parts: [{ text: lastAiMessage }] }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: { voiceName: "Kore" } 
                    }
                }
            },
            model: "gemini-2.5-flash-preview-tts"
        };
        
        let attempts = 0;
        let result = null;
        while (attempts < 5) {
            attempts++;
            const response = await fetch(TTS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                result = await response.json();
                break;
            } else if (response.status === 429 && attempts < 5) {
                const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                const status = response.status;
                const statusText = response.statusText;
                const errorBody = await response.text();
                
                // HATA DETAYINI KONSOLA LOGLAMA
                console.error(`MUAI TTS HATA DETAY: HTTP Status ${status} - ${statusText}. Yanıt gövdesi:`, errorBody.substring(0, 500));

                throw new Error(`TTS API HTTP Hatası: ${status} - ${statusText}. (Detaylar Konsolda)`);
            }
        }

        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType;

        if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
            const match = mimeType.match(/rate=(\d+)/);
            const sampleRate = match ? parseInt(match[1], 10) : 16000; 

            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            
            ttsAudio.src = URL.createObjectURL(wavBlob);
            ttsAudio.play();

            ttsAudio.onended = () => setTtsLoading(false);
        } else {
            throw new Error("Geçersiz veya eksik ses verisi.");
        }

    } catch (error) {
        console.error("TTS hatası:", error);
        showModal("Seslendirme Başarısız", "Ses dosyası oluşturulamadı veya oynatılamadı. Konsolu kontrol edin.", 'Tamam');
        setTtsLoading(false);
    }
}

// --- Başlangıç ---
window.onload = function() {
    loadData(); 
    
    // Sidebar başlangıçta kapalı (mobil ve masaüstü için)
    sidebar.classList.add('-translate-x-full');
    menuIcon.classList.remove('hidden');
    closeIcon.classList.add('hidden');

    if (!activeChatId || chatsMeta.length === 0) startNewChat();
    else switchChat(activeChatId); 
    
    renderChatList();
    userInput.focus();

    ttsAudio.addEventListener('pause', () => setTtsLoading(false));
    ttsAudio.addEventListener('error', () => setTtsLoading(false));
};

</script>

</body>
</html>
