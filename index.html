<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nova Yapay Zeka Asistanı (Local)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LZ-String (sıkıştırma için) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    :root { font-family: 'Inter', sans-serif; }
    body, html { height: 100%; overflow: hidden; background:#0f172a; color:#e6eef8; }
    /* kısa stiller (orijinalinden hafifçe sadeleştirildi) */
    .chat { height: calc(100vh - 160px); overflow:auto; padding:16px; }
    .msg { max-width:85%; padding:12px; border-radius:12px; margin-bottom:8px; box-shadow:0 2px 6px rgba(0,0,0,.6); }
    .user { margin-left:auto; background:#4f46e5; color:#fff; border-bottom-right-radius:2px; }
    .ai { margin-right:auto; background:#1f2937; color:#e6eef8; border-top-left-radius:2px; }
    .loading { display:inline-block; width:12px; height:12px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    img.result { max-width:320px; border-radius:8px; display:block; margin-top:8px; border:1px solid #374151; }
    footer { position:relative; padding:12px; background:#0b1220; border-top:1px solid #111827; }
    .share-link { font-size:12px; color:#93c5fd; word-break:break-all; }
  </style>
</head>
<body class="flex">

  <main style="flex:1; display:flex; flex-direction:column;">
    <header style="padding:12px; background:#071029; border-bottom:1px solid #0b1220;">
      <h1 style="font-weight:700; color:#60a5fa;">Nova (Local) - StableDiffusion Ready</h1>
    </header>

    <div id="chat" class="chat"></div>

    <footer>
      <div style="display:flex; gap:8px;">
        <input id="input" type="text" placeholder="Örnek: 'Bakü'de kırmızı bir spor araba fotoğrafı oluştur' " style="flex:1;padding:10px;border-radius:8px;background:#0f172a;border:1px solid #1f2937;color:#e6eef8;" />
        <button id="send" style="padding:10px 14px;border-radius:8px;background:#2563eb;color:white;">Gönder</button>
      </div>
      <div id="status" style="margin-top:8px;color:#fca5a5;display:none;"></div>
      <div id="share" style="margin-top:8px;"></div>
    </footer>
  </main>

<script>
/* ---------- AYARLAR (burayı kendi ortamına göre değiştir) ---------- */
// Eğer local Automatic1111 / sd-webui kullanıyorsan LOCAL_SD_API'i ayarla.
// Örnek: 'http://127.0.0.1:7860'  (Automatic1111 sd-webui varsayılan)
const USE_SD_API = true;                // true -> local SD endpoint'e istek atar; false -> fallback canvas üretimi
const LOCAL_SD_API = 'http://127.0.0.1:7860'; // kendi local SD adresin
/* ------------------------------------------------------------------ */

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const status = document.getElementById('status');
const share = document.getElementById('share');

function addMsg(text, cls='ai') {
  const d = document.createElement('div');
  d.className = 'msg ' + (cls==='user' ? 'user' : 'ai');
  if (typeof text === 'string') d.innerHTML = text;
  else d.appendChild(text);
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

/* Basit markdown (kalın/italik) */
function mdToHtml(s){ return s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>'); }

/* Shareable link oluştur: base64 -> sıkıştır -> URL hash */
function makeShareLinkFromBase64(b64) {
  const compressed = LZString.compressToEncodedURIComponent(b64);
  const url = location.origin + location.pathname + '#img=' + compressed;
  return url;
}

/* Sayfa açıldığında eğer hash'te img varsa göster */
function tryLoadFromHash() {
  if (!location.hash) return;
  const m = location.hash.match(/#img=(.+)/);
  if (!m) return;
  try {
    const b64 = LZString.decompressFromEncodedURIComponent(m[1]);
    if (!b64) return;
    const img = document.createElement('img');
    img.className = 'result';
    img.src = 'data:image/png;base64,' + b64;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = '<div style="font-size:13px;color:#9ca3af;margin-bottom:6px">Paylaşılan görsel</div>';
    wrapper.appendChild(img);
    addMsg(wrapper, 'ai');
  } catch (e) {
    console.error(e);
  }
}
tryLoadFromHash();

/* Canvas fallback (pseudo-photorealistic değil, fakat makul kompozitler üretir) */
function generateCanvasImage(prompt) {
  // Basit kompozit: gradient arka plan + SVG araba silhouette (basitleştirilmiş) + şehir adı metni
  const w = 1024, h = 640;
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');

  // background gradient (şehir havası)
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, '#0f172a'); g.addColorStop(1, '#0b1220');
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

  // basit "fotoğraf efekti" gürültü
  const imgd = ctx.getImageData(0,0,w,h);
  for (let i=0;i<imgd.data.length;i+=4){
    const v = (Math.random()-0.5)*8;
    imgd.data[i]+=v; imgd.data[i+1]+=v; imgd.data[i+2]+=v;
  }
  ctx.putImageData(imgd,0,0);

  // basit araba silhouette as overlay (SVG yolu yerine şekil)
  ctx.fillStyle = '#111827';
  ctx.beginPath();
  ctx.moveTo(200,420); ctx.lineTo(300,360); ctx.lineTo(500,360); ctx.lineTo(620,420);
  ctx.lineTo(820,420); ctx.lineTo(780,480); ctx.lineTo(240,480);
  ctx.closePath(); ctx.fill();

  // wheels
  ctx.fillStyle = '#0b1220';
  ctx.beginPath(); ctx.arc(320,480,34,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(700,480,34,0,Math.PI*2); ctx.fill();

  // şehir adı ve prompt kısa yazısı
  ctx.fillStyle = '#e6eef8';
  ctx.font = '36px Inter, sans-serif';
  ctx.fillText(prompt.slice(0,60), 40, 80);

  // dönüştür + base64
  const b64 = c.toDataURL('image/png').split(',')[1];
  return b64;
}

/* Automatic1111 sd-webui ile uyumlu request (txt2img) */
async function callLocalSD(prompt) {
  // Örnek minimal payload; senin kurulumuna göre params ekleyebilirsin.
  const url = (LOCAL_SD_API||'http://127.0.0.1:7860').replace(/\/$/,'') + '/sdapi/v1/txt2img';
  const payload = {
    prompt: prompt,
    negative_prompt: '',
    steps: 20,
    cfg_scale: 7,
    width: 1024,
    height: 640,
    sampler_index: "Euler a",
    restore_faces: false
  };

  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error('SD API hata: ' + resp.status + ' - ' + txt);
  }
  const json = await resp.json();
  // sd-webui returns images (base64) in json.images array
  const b64 = json.images?.[0];
  if (!b64) throw new Error('SD API dönışı beklenmedik.');
  return b64;
}

/* Ana gönderme fonksiyonu */
sendBtn.onclick = async () => {
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  addMsg(mdToHtml(text), 'user');

  // loading placeholder
  const loading = document.createElement('div');
  loading.innerHTML = 'Nova üretiyor... <span class="loading"></span>';
  addMsg(loading, 'ai');

  try {
    let base64;
    if (USE_SD_API) {
      status.style.display = 'block';
      status.textContent = 'Local SD API ile oluşturuluyor...';
      try {
        base64 = await callLocalSD(text);
      } catch (e) {
        // eğer SD çağrısı başarısızsa fallback olarak canvas üretimi uygula
        console.warn('SD çağrısı başarısız, fallback canvas üretiliyor:', e);
        status.textContent = 'Local SD erişimi başarısız — fallback canvas ile üretildi.';
        base64 = generateCanvasImage(text);
      }
    } else {
      status.style.display = 'block';
      status.textContent = 'Canvas ile üretiliyor (offline)...';
      base64 = generateCanvasImage(text);
    }

    // placeholder'ı kaldır ve resmi göster
    if (loading && loading.parentNode) loading.parentNode.remove();

    const img = document.createElement('img');
    img.className = 'result';
    img.src = 'data:image/png;base64,' + base64;

    const wrapper = document.createElement('div');
    wrapper.appendChild(img);

    // Açıklama ve indirme butonu
    const dl = document.createElement('a');
    dl.href = img.src;
    dl.download = 'nova_image.png';
    dl.textContent = 'İndir';
    dl.style.cssText = 'display:inline-block;margin-top:8px;padding:6px 8px;background:#111827;color:#e6eef8;border-radius:6px;text-decoration:none;font-size:13px';
    wrapper.appendChild(dl);

    addMsg(wrapper, 'ai');

    // share link oluştur
    const shareUrl = makeShareLinkFromBase64(base64);
    share.innerHTML = `<div style="color:#9ca3af;font-size:13px">Paylaşılabilir link (kopyala & paylaş):</div>
                       <div class="share-link">${shareUrl}</div>`;

    status.style.display = 'none';
  } catch (err) {
    console.error(err);
    status.style.display = 'block';
    status.textContent = 'Hata: ' + (err.message || err);
  }
};

input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendBtn.click(); });

</script>
</body>
</html>
