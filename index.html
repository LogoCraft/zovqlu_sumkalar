<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã‡oklu Sohbet AI AsistanÄ±</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .ai-message {
            background-color: #ffffff;
            border-radius: 0.75rem 0.75rem 0.75rem 0; /* Sol Ã¼st, SaÄŸ Ã¼st, SaÄŸ alt, Sol alt */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            border-radius: 0.75rem 0.75rem 0 0.75rem; /* Sol Ã¼st, SaÄŸ Ã¼st, SaÄŸ alt, Sol alt */
        }
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Tam Ekran GÃ¶rÃ¼ntÃ¼sÃ¼ */
        .full-screen-app {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            display: flex;
            position: relative; /* Sidebar'Ä±n konumlandÄ±rÄ±lmasÄ± iÃ§in */
        }
        /* Sidebar'Ä±n geÃ§iÅŸ ayarlarÄ± */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            position: absolute;
            height: 100%;
            z-index: 50; /* Ana iÃ§eriÄŸin Ã¼zerinde kalmasÄ± iÃ§in */
        }
        /* Custom spinner for TTS loading */
        .tts-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="full-screen-app">

    <!-- Sidebar - Sohbet Listesi. BaÅŸlangÄ±Ã§ta gizli. -->
    <div id="sidebar" class="w-64 bg-gray-900 text-white flex flex-col shadow-xl transform -translate-x-full"> 
        <div class="p-4 border-b border-gray-700">
            <h2 class="text-2xl font-bold">ðŸ’¬ Sohbetler</h2>
        </div>
        
        <!-- Yeni Sohbet Butonu -->
        <button onclick="startNewChat(); toggleSidebar()" class="m-3 p-3 bg-indigo-600 rounded-lg text-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
            + Yeni Sohbet BaÅŸlat
        </button>

        <!-- Sohbet Listesi -->
        <div id="chat-list" class="flex-grow overflow-y-auto px-3 space-y-1">
            <!-- Chat list items will be injected here -->
        </div>

    </div>

    <!-- Main Chat Window -->
    <div id="main-chat-window" class="flex-grow flex flex-col bg-gray-50 max-w-full w-full">
        
        <!-- Header -->
        <header class="p-4 bg-white border-b border-gray-200 shadow-md flex items-center">
            
            <!-- Sidebar Toggle Button (Sol Ãœst KÃ¶ÅŸe) -->
            <button id="menu-toggle" onclick="toggleSidebar()" class="p-2 mr-4 text-gray-600 hover:text-indigo-600 focus:outline-none">
                <!-- Hamburger Ä°konu -->
                <svg id="menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
                <!-- Kapatma Ä°konu (Ã‡apraz) -->
                <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

            <h1 id="chat-title" class="text-xl font-bold text-gray-800 truncate flex-grow">Sohbet BaÅŸlÄ±ÄŸÄ± YÃ¼kleniyor...</h1>

            <!-- Yeni Ã–zellikler ButonlarÄ± -->
            <button id="summarize-button" onclick="summarizeChat()"
                    class="ml-4 p-2 bg-purple-500 text-white rounded-lg shadow-md hover:bg-purple-600 transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm font-medium disabled:opacity-50 flex items-center">
                <span id="summarize-text">Ã–zetle âœ¨</span>
                <div id="summarize-spinner" class="tts-spinner hidden ml-2 border-t-white"></div>
            </button>
            
            <button id="tts-button" onclick="speakLastAiMessage()"
                    class="ml-2 p-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition duration-150 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm font-medium disabled:opacity-50 flex items-center">
                <span id="tts-text">Seslendir ðŸ”Š</span>
                <div id="tts-spinner" class="tts-spinner hidden ml-2 border-t-white"></div>
            </button>

            <!-- Sohbet Sil Butonu -->
            <button id="delete-button" onclick="confirmAndDeleteChat()"
                    class="bg-red-500 text-white p-2 ml-4 rounded-lg shadow-md hover:bg-red-600 transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-medium disabled:opacity-50">
                Sohbeti Sil
            </button>
        </header>

        <!-- Chat Area -->
        <div id="chat-container" class="chat-container p-6 space-y-4">
            <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200 flex items-center space-x-3 shadow-inner">
            <input type="text" id="user-input" placeholder="Sorunuzu buraya yazÄ±n..."
                   class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                   onkeydown="if(event.key === 'Enter') sendMessage()">
            
            <button id="send-button" onclick="sendMessage()"
                    class="bg-indigo-600 text-white p-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 flex items-center justify-center w-12 h-12">
                <svg id="send-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
                <div id="loading-spinner" class="hidden w-6 h-6 border-3 border-t-3 border-white rounded-full animate-spin"></div>
            </button>
        </div>
        
    </div>
    
    <!-- Custom Confirmation Modal (Confirm() yerine kullanÄ±lÄ±r) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4 text-gray-800">Sohbeti Silme OnayÄ±</h3>
            <p id="modal-message" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal(false)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">Ä°ptal</button>
                <button id="modal-confirm-button" onclick="hideModal(true)" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">Sil</button>
            </div>
        </div>
    </div>

    <!-- Ses OynatÄ±cÄ± (GÃ¶rÃ¼nmez) -->
    <audio id="tts-audio" style="display: none;"></audio>
    
    <script>
        // --- Sabitler ve Global DeÄŸiÅŸkenler ---
        const API_KEY = "AIzaSyC5TjJMwl_kjTF9unQbpik5exA8WDn0_Bk";
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        
        // Depolama anahtarlarÄ±
        const CHATS_META_KEY = 'aiChatMetadata';
        const ACTIVE_CHAT_KEY = 'activeAiChatId';

        // UI Elementleri
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const chatListElement = document.getElementById('chat-list');
        const chatTitleElement = document.getElementById('chat-title');
        const sidebar = document.getElementById('sidebar');
        const menuIcon = document.getElementById('menu-icon');
        const closeIcon = document.getElementById('close-icon');
        const summarizeButton = document.getElementById('summarize-button');
        const summarizeSpinner = document.getElementById('summarize-spinner');
        const summarizeText = document.getElementById('summarize-text');
        const ttsButton = document.getElementById('tts-button');
        const ttsSpinner = document.getElementById('tts-spinner');
        const ttsText = document.getElementById('tts-text');
        const ttsAudio = document.getElementById('tts-audio');

        // Modal Elementleri
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        let modalCallback = null; // Modal onaylandÄ±ÄŸÄ±nda Ã§aÄŸrÄ±lacak fonksiyon

        // Durum DeÄŸiÅŸkenleri
        let chatsMeta = [];      // TÃ¼m sohbetlerin listesi: [{ id: '...', title: '...' }]
        let activeChatId = null; // Åžu anda aktif olan sohbetin ID'si
        let chatHistory = [];    // Aktif sohbetin mesaj geÃ§miÅŸi
        let isProcessing = false;
        let isTtsProcessing = false;
        let isSummarizing = false;

        // --- Utility Functions for TTS (PCM to WAV conversion) ---

        /**
         * Base64 string'i ArrayBuffer'a dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         */
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Signed 16-bit PCM verisini bir WAV dosyasÄ± Blob'una dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         */
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            /* RIFF identifier */
            writeString(view, 0, 'RIFF');
            /* file length */
            view.setUint32(4, 36 + pcm16.length * 2, true);
            /* RIFF type */
            writeString(view, 8, 'WAVE');
            /* format chunk identifier */
            writeString(view, 12, 'fmt ');
            /* format chunk length */
            view.setUint32(16, 16, true);
            /* sample format (1: PCM) */
            view.setUint16(20, 1, true);
            /* channel count */
            view.setUint16(22, 1, true);
            /* sample rate */
            view.setUint32(24, sampleRate, true);
            /* byte rate (sample rate * block align) */
            view.setUint32(28, sampleRate * 2, true);
            /* block align (channels * bytes per sample) */
            view.setUint16(32, 2, true);
            /* bits per sample */
            view.setUint16(34, 16, true);
            /* data chunk identifier */
            writeString(view, 36, 'data');
            /* data chunk length */
            view.setUint32(40, pcm16.length * 2, true);

            // PCM verisini yaz
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // --- YENÄ° Fonksiyonlar: Sidebar ve Modal ---
        
        /**
         * Sidebar'Ä± gÃ¶sterir veya gizler.
         */
        function toggleSidebar() {
            // translate-x-full: gizli, translate-x-0: aÃ§Ä±k
            const isOpen = sidebar.classList.toggle('-translate-x-full');
            
            if (isOpen) {
                // AÃ§Ä±ldÄ±: Kapatma ikonunu gÃ¶ster
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
                sidebar.classList.add('-translate-x-full'); // Gizli
            } else {
                // Gizlendi: MenÃ¼ ikonunu gÃ¶ster
                menuIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
                sidebar.classList.remove('-translate-x-full'); // AÃ§Ä±k
            }

            // Hata: YanlÄ±ÅŸ mantÄ±k. DoÄŸrusu:
            // -translate-x-full varsa: GÄ°ZLÄ°, menÃ¼ ikonunu gÃ¶ster
            // -translate-x-full yoksa: AÃ‡IK, kapatma ikonunu gÃ¶ster
             
            if (sidebar.classList.contains('-translate-x-full')) {
                // Gizli: MenÃ¼ ikonunu gÃ¶ster, Kapatma ikonunu gizle
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            } else {
                // AÃ§Ä±k: MenÃ¼ ikonunu gizle, Kapatma ikonunu gÃ¶ster
                menuIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
            }
        }
        
        /**
         * Basit, geÃ§ici bir bildirim gÃ¶sterir (alert() yerine).
         */
        function showTemporaryMessage(message, bgColor) {
            const tempMessage = document.createElement('div');
            tempMessage.className = `fixed top-4 right-4 ${bgColor} text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0`;
            tempMessage.textContent = message;
            document.body.appendChild(tempMessage);

            // OpaklÄ±ÄŸÄ± sÄ±fÄ±rdan bire Ã§Ä±kar
            requestAnimationFrame(() => {
                tempMessage.style.opacity = '1';
            });

            setTimeout(() => {
                tempMessage.style.opacity = '0';
                tempMessage.addEventListener('transitionend', () => tempMessage.remove());
            }, 3000);
        }

        /**
         * Ã–zel onay modalÄ±nÄ± gÃ¶sterir.
         */
        function showModal(message, onConfirm) {
            modalMessage.textContent = message;
            modalCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        /**
         * Ã–zel onay modalÄ±nÄ± gizler ve geri Ã§aÄŸrÄ±yÄ± (callback) tetikler.
         */
        function hideModal(confirmed) {
            confirmationModal.classList.add('hidden');
            if (confirmed && modalCallback) {
                modalCallback();
            }
            modalCallback = null;
        }

        // --- YardÄ±mcÄ± Fonksiyonlar ---

        /**
         * MesajlarÄ± ve kaynaklarÄ± ekrana basar.
         */
        function displayMessage(text, role, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 max-w-3/4 rounded-xl shadow-md whitespace-pre-wrap ${role === 'user' ? 'user-message' : 'ai-message'}`;

            const formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');

            messageBubble.innerHTML = formattedText;

            // KaynaklarÄ± AI mesajÄ±nÄ±n altÄ±na ekle
            if (role === 'ai' && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'mt-3 pt-2 border-t border-gray-200 text-xs text-gray-500 space-y-1';
                sourcesDiv.innerHTML = '<span class="font-semibold text-gray-600">Kaynaklar:</span>';

                sources.forEach((source) => {
                    const link = document.createElement('a');
                    link.href = source.uri;
                    link.target = '_blank';
                    link.className = 'block hover:text-indigo-600 truncate';
                    link.textContent = `â€¢ ${source.title || source.uri}`;
                    sourcesDiv.appendChild(link);
                });
                messageBubble.appendChild(sourcesDiv);
            }

            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * UI durumunu (gÃ¶nder/yÃ¼kleniyor) gÃ¼nceller.
         */
        function setUILoading(loading) {
            isProcessing = loading;
            userInput.disabled = loading;
            sendButton.disabled = loading;
            summarizeButton.disabled = loading || isSummarizing || isTtsProcessing;
            ttsButton.disabled = loading || isSummarizing || isTtsProcessing;

            if (loading) {
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function setSummarizeLoading(loading) {
            isSummarizing = loading;
            summarizeButton.disabled = loading || isProcessing || isTtsProcessing;
            if (loading) {
                summarizeText.classList.add('hidden');
                summarizeSpinner.classList.remove('hidden');
            } else {
                summarizeText.classList.remove('hidden');
                summarizeSpinner.classList.add('hidden');
            }
        }
        
        function setTtsLoading(loading) {
            isTtsProcessing = loading;
            ttsButton.disabled = loading || isProcessing || isSummarizing;
            if (loading) {
                ttsText.textContent = "Ses YÃ¼kleniyor...";
                ttsSpinner.classList.remove('hidden');
            } else {
                ttsText.textContent = "Seslendir ðŸ”Š";
                ttsSpinner.classList.add('hidden');
            }
        }
        
        // --- Ã‡oklu Sohbet YÃ¶netimi FonksiyonlarÄ± ---

        /**
         * Yeni benzersiz bir sohbet kimliÄŸi (ID) oluÅŸturur.
         */
        function generateChatId() {
            return 'chat_' + Date.now() + Math.random().toString(16).substring(2, 8);
        }

        /**
         * TÃ¼m sohbet meta verilerini (ID, BaÅŸlÄ±k) localStorage'dan yÃ¼kler.
         */
        function loadChatsMeta() {
            try {
                const storedMeta = localStorage.getItem(CHATS_META_KEY);
                chatsMeta = storedMeta ? JSON.parse(storedMeta) : [];
                activeChatId = localStorage.getItem(ACTIVE_CHAT_KEY);
            } catch (error) {
                console.error("Meta veri yÃ¼klenirken hata:", error);
                chatsMeta = [];
                activeChatId = null;
            }
        }

        /**
         * TÃ¼m sohbet meta verilerini (ID, BaÅŸlÄ±k) localStorage'a kaydeder.
         */
        function saveChatsMeta() {
            localStorage.setItem(CHATS_META_KEY, JSON.stringify(chatsMeta));
            if (activeChatId) {
                localStorage.setItem(ACTIVE_CHAT_KEY, activeChatId);
            } else {
                localStorage.removeItem(ACTIVE_CHAT_KEY);
            }
        }

        /**
         * Belirli bir sohbet geÃ§miÅŸini yÃ¼kler.
         */
        function loadChatHistory(chatId) {
            try {
                const storedHistory = localStorage.getItem(chatId);
                chatHistory = storedHistory ? JSON.parse(storedHistory) : [];
                return chatHistory;
            } catch (error) {
                console.error(`Sohbet geÃ§miÅŸi (${chatId}) yÃ¼klenirken hata:`, error);
                return [];
            }
        }

        /**
         * Aktif sohbet geÃ§miÅŸini kaydeder.
         */
        function saveActiveChatHistory() {
            if (activeChatId && chatHistory.length > 0) {
                localStorage.setItem(activeChatId, JSON.stringify(chatHistory));
            }
            
            // Ä°lk mesajÄ± kullanarak baÅŸlÄ±k oluÅŸtur ve meta veriyi gÃ¼ncelle
            const firstUserMessage = chatHistory.find(msg => msg.role === 'user');
            if (firstUserMessage) {
                const newTitle = firstUserMessage.parts[0].text.substring(0, 30) + '...';
                let chatMeta = chatsMeta.find(meta => meta.id === activeChatId);

                if (chatMeta) {
                    chatMeta.title = newTitle;
                    // En son kullanÄ±lanÄ± en Ã¼ste taÅŸÄ±mak iÃ§in zaman damgasÄ±nÄ± gÃ¼ncelle
                    chatMeta.timestamp = Date.now(); 
                } else {
                    chatsMeta.push({ id: activeChatId, title: newTitle, timestamp: Date.now() });
                }
                saveChatsMeta();
            }
            renderChatList();
        }

        /**
         * Belirtilen sohbete geÃ§er ve UI'Ä± gÃ¼nceller.
         */
        function switchChat(chatId) {
            if (isProcessing || isSummarizing || isTtsProcessing) {
                showTemporaryMessage("LÃ¼tfen Ã¶nceki iÅŸlemin bitmesini bekleyin.", 'bg-yellow-500');
                return;
            }
            
            // Mevcut sohbeti kaydet (eÄŸer varsa)
            if (activeChatId) {
                saveActiveChatHistory();
            }

            activeChatId = chatId;
            
            // Yeni sohbet geÃ§miÅŸini yÃ¼kle
            chatHistory = loadChatHistory(chatId);
            
            // UI'Ä± temizle ve yeni geÃ§miÅŸi gÃ¶rÃ¼ntÃ¼le
            chatContainer.innerHTML = '';
            chatHistory.forEach(msg => {
                const text = msg.parts[0].text;
                const sources = msg.sources || [];
                displayMessage(text, msg.role, sources);
            });
            
            // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
            const chatMeta = chatsMeta.find(meta => meta.id === chatId);
            chatTitleElement.textContent = chatMeta ? chatMeta.title : 'Yeni Sohbet';
            
            // Sidebar'daki aktifliÄŸi iÅŸaretle
            document.querySelectorAll('.chat-item').forEach(el => {
                el.classList.remove('bg-indigo-700');
                if (el.dataset.chatId === chatId) {
                    el.classList.add('bg-indigo-700');
                }
            });

            saveChatsMeta(); // Aktif sohbet ID'sini kaydet
            userInput.focus();
            
            // Yeni sohbete geÃ§erken TTS/Summarize buton durumlarÄ±nÄ± sÄ±fÄ±rla
            setUILoading(false); 
        }

        /**
         * Yeni bir sohbet oturumu baÅŸlatÄ±r.
         */
        function startNewChat() {
            // Mevcut sohbeti kaydet
            if (activeChatId) {
                saveActiveChatHistory();
            }

            const newId = generateChatId();
            const newMeta = { id: newId, title: 'Yeni Sohbet', timestamp: Date.now() };

            chatsMeta.unshift(newMeta); // En Ã¼ste ekle
            saveChatsMeta();
            
            // Yeni sohbete geÃ§
            switchChat(newId);
        }

        /**
         * Sidebar'daki sohbet listesini yeniden oluÅŸturur.
         */
        function renderChatList() {
            chatListElement.innerHTML = '';
            
            // En son kullanÄ±lanÄ± Ã¼ste taÅŸÄ±mak iÃ§in sÄ±ralama yap
            chatsMeta.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (chatsMeta.length === 0) {
                 // Ä°lk Ã§alÄ±ÅŸtÄ±rmada veya tÃ¼mÃ¼ silindiÄŸinde yeni bir sohbet baÅŸlat.
                 return; 
            }

            chatsMeta.forEach(meta => {
                const item = document.createElement('div');
                item.className = `chat-item p-3 rounded-lg cursor-pointer hover:bg-gray-800 transition duration-100 truncate ${meta.id === activeChatId ? 'bg-indigo-700' : ''}`;
                item.textContent = meta.title;
                item.dataset.chatId = meta.id;
                item.onclick = () => switchChat(meta.id);
                chatListElement.appendChild(item);
            });
        }
        
        /**
         * Sohbeti silmeyi onaylar ve iÅŸlemi gerÃ§ekleÅŸtirir. (Ã–zel Modal kullanÄ±lÄ±r)
         */
        function confirmAndDeleteChat() {
            if (!activeChatId) return;

            const chatMeta = chatsMeta.find(meta => meta.id === activeChatId);
            const title = chatMeta ? chatMeta.title : 'Bu Sohbeti';
            
            // Ã–zel modalÄ± gÃ¶ster
            showModal(
                `"${title}" sohbetini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`,
                () => deleteChat(activeChatId)
            );
        }
        
        /**
         * Belirtilen sohbeti tamamen siler.
         */
        function deleteChat(chatIdToDelete) {
            // 1. localStorage'dan geÃ§miÅŸi sil
            localStorage.removeItem(chatIdToDelete);

            // 2. Meta veriden kaldÄ±r
            const index = chatsMeta.findIndex(meta => meta.id === chatIdToDelete);
            if (index > -1) {
                chatsMeta.splice(index, 1);
            }
            saveChatsMeta();

            // 3. Aktif sohbeti kontrol et ve yÃ¶nlendir
            if (chatIdToDelete === activeChatId) {
                if (chatsMeta.length > 0) {
                    // Kalan son sohbete geÃ§
                    switchChat(chatsMeta[0].id);
                } else {
                    // BaÅŸka sohbet yoksa yeni bir tane baÅŸlat
                    startNewChat();
                }
            } else {
                // Sadece listeyi yeniden render et
                renderChatList();
            }
        }
        

        // --- Gemini API Ã‡aÄŸrÄ±larÄ± ---
        
        // Gemini Text Generation API Call (Mevcut sohbet ve Ã¶zetleme iÃ§in)
        async function getGeminiResponse(userQuery, history = chatHistory, systemPrompt = "Sen, kullanÄ±cÄ±nÄ±n sorularÄ±na TÃ¼rkÃ§e olarak doÄŸru, gÃ¼ncel ve ayrÄ±ntÄ±lÄ± cevaplar veren, profesyonel bir yapay zeka asistanÄ±sÄ±n. YanÄ±tlarÄ±nÄ± verirken her zaman Google Arama sonuÃ§larÄ±nÄ± kullan ve Markdown formatÄ±nÄ± koru.", useSearch = true) {
            
            const conversationHistoryForApi = history.map(msg => ({
                role: msg.role, 
                parts: msg.parts
            }));

            if (userQuery) {
                conversationHistoryForApi.push({ role: 'user', parts: [{ text: userQuery }] });
            }
            
            const payload = {
                contents: conversationHistoryForApi,
                tools: useSearch ? [{ "google_search": {} }] : [], 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 5;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(TEXT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                        continue;
                    }

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API HatasÄ±: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        return { text, sources };

                    } else {
                        return { text: "ÃœzgÃ¼nÃ¼m, geÃ§erli bir yanÄ±t alamadÄ±m.", sources: [] };
                    }
                } catch (error) {
                    console.error("API Ã§aÄŸrÄ±sÄ± sÄ±rasÄ±nda hata:", error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                    } else {
                        throw new Error(`Yapay Zeka ile iletiÅŸim kurulamadÄ±: ${error.message}`);
                    }
                }
            }
        }

        // Gemini TTS API Call
        async function getGeminiTtsAudio(textToSpeak) {
            
            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        // TÃ¼rkÃ§e'ye uygun bir ses seÃ§imi: Leda (Youthful)
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const maxRetries = 5;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                        continue;
                    }

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`TTS API HatasÄ±: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        return URL.createObjectURL(wavBlob);
                    } else {
                        throw new Error("GeÃ§erli ses verisi veya mimeType alÄ±namadÄ±.");
                    }
                } catch (error) {
                    console.error("TTS API Ã§aÄŸrÄ±sÄ± sÄ±rasÄ±nda hata:", error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                    } else {
                        throw new Error(`TTS ile iletiÅŸim kurulamadÄ±: ${error.message}`);
                    }
                }
            }
        }


        // --- YENÄ° Ã–zellik FonksiyonlarÄ± ---

        /**
         * Mevcut sohbet geÃ§miÅŸini Ã¶zetler ve sonucu sohbete ekler.
         */
        async function summarizeChat() {
            if (isProcessing || isSummarizing || isTtsProcessing || chatHistory.length === 0) {
                if (chatHistory.length === 0) {
                    showTemporaryMessage("Ã–zetlenecek mesaj yok. LÃ¼tfen sohbete baÅŸlayÄ±n.", 'bg-yellow-500');
                } else {
                    showTemporaryMessage("LÃ¼tfen devam eden iÅŸlemi bekleyin.", 'bg-yellow-500');
                }
                return;
            }

            setSummarizeLoading(true);

            // Ã–zetleme iÃ§in sadece metin iÃ§eriklerini birleÅŸtir.
            const chatTranscript = chatHistory.map(msg => 
                `${msg.role === 'user' ? 'KullanÄ±cÄ±' : 'AI'}: ${msg.parts[0].text}`
            ).join('\n');

            const systemPrompt = "Sen bir Ã¶zetleme uzmanÄ±sÄ±n. AÅŸaÄŸÄ±daki konuÅŸmanÄ±n ana noktalarÄ±nÄ±, Ã¶nemli kararlarÄ±nÄ± ve sonuÃ§larÄ±nÄ± vurgulayarak 3-4 cÃ¼mlelik TÃ¼rkÃ§e bir Ã¶zetini Ã§Ä±kar. Ã–zetini doÄŸrudan Markdown formatÄ±nda sun.";
            
            try {
                // Not: Ã–zetleme isteÄŸi iÃ§in Google AramayÄ± kapatÄ±yoruz (useSearch = false)
                const { text: summaryText } = await getGeminiResponse(
                    `LÃ¼tfen ÅŸu sohbeti Ã¶zetleyin:\n\n${chatTranscript}`, 
                    [], // GeÃ§miÅŸi sÄ±fÄ±rla, Ã§Ã¼nkÃ¼ transkripti sorguda gÃ¶nderiyoruz
                    systemPrompt, 
                    false // Arama kullanma
                );

                // Ã–zetleme mesajÄ±nÄ± sohbete ekle
                const summaryTitle = "âœ¨ Sohbet Ã–zeti (Gemini AI tarafÄ±ndan):";
                displayMessage(`**${summaryTitle}**\n\n${summaryText}`, 'ai');
                
                // Ã–zeti chat geÃ§miÅŸine kaydet
                chatHistory.push({ 
                    role: 'ai', 
                    parts: [{ text: `${summaryTitle}\n\n${summaryText}` }], 
                    sources: []
                });
                saveActiveChatHistory();


            } catch (error) {
                displayMessage(`Ã–zetleme sÄ±rasÄ±nda hata oluÅŸtu: ${error.message}`, 'ai');
            } finally {
                setSummarizeLoading(false);
            }
        }

        /**
         * AI'nÄ±n verdiÄŸi son mesajÄ± TTS ile sese dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve oynatÄ±r.
         */
        async function speakLastAiMessage() {
            if (isProcessing || isSummarizing || isTtsProcessing) {
                showTemporaryMessage("LÃ¼tfen devam eden iÅŸlemi bekleyin.", 'bg-yellow-500');
                return;
            }

            // Son AI mesajÄ±nÄ± bul
            const lastAiMessage = chatHistory.slice().reverse().find(msg => msg.role === 'ai');
            if (!lastAiMessage || !lastAiMessage.parts[0].text) {
                showTemporaryMessage("Seslendirilecek bir AI mesajÄ± bulunamadÄ±.", 'bg-yellow-500');
                return;
            }

            // MesajÄ±n iÃ§eriÄŸini al ve varsa baÅŸlÄ±ÄŸÄ± temizle
            let textToSpeak = lastAiMessage.parts[0].text;
            if (textToSpeak.startsWith('âœ¨ Sohbet Ã–zeti')) {
                 textToSpeak = textToSpeak.substring(textToSpeak.indexOf(')\n\n') + 3).trim();
            }

            setTtsLoading(true);

            try {
                // 1. Ses dosyasÄ±nÄ± al
                const audioUrl = await getGeminiTtsAudio(textToSpeak);

                // 2. Oynat
                ttsAudio.src = audioUrl;
                await ttsAudio.play();
                
                showTemporaryMessage("Ses oynatÄ±lÄ±yor...", 'bg-green-600');

                // Oynatma bitince yÃ¼kleme durumunu sÄ±fÄ±rla
                ttsAudio.onended = () => {
                    setTtsLoading(false);
                    URL.revokeObjectURL(audioUrl);
                };

            } catch (error) {
                showTemporaryMessage(`Seslendirme baÅŸarÄ±sÄ±z: ${error.message}`, 'bg-red-500');
                console.error("TTS Hata:", error);
            } finally {
                // EÄŸer hata olursa ve onended tetiklenmezse diye
                if (ttsAudio.src === '') { 
                    setTtsLoading(false);
                }
            }
        }


        // --- Ana Ä°ÅŸlem Fonksiyonu ---

        async function sendMessage() {
            const query = userInput.value.trim();
            if (!query || isProcessing || !activeChatId) return;

            // EÄŸer bu yeni bir sohbetteki ilk mesajsa, baÅŸlÄ±ÄŸÄ± ayarla
            if (chatHistory.length === 0) {
                 const newTitle = query.substring(0, 30) + '...';
                 const metaIndex = chatsMeta.findIndex(meta => meta.id === activeChatId);
                 if (metaIndex > -1) {
                    chatsMeta[metaIndex].title = newTitle;
                    chatsMeta[metaIndex].timestamp = Date.now();
                 }
                 chatTitleElement.textContent = newTitle;
                 saveChatsMeta();
                 renderChatList();
            }

            // 1. Sidebar aÃ§Ä±ksa kapat (sadece bÃ¼yÃ¼k ekranlarda)
            const sidebarIsVisible = !sidebar.classList.contains('-translate-x-full');
            if (sidebarIsVisible) {
                 toggleSidebar();
            }

            // 2. UI'Ä± HazÄ±rla
            userInput.value = '';
            setUILoading(true);

            // 3. KullanÄ±cÄ± MesajÄ±nÄ± GÃ¶rÃ¼ntÃ¼le ve GeÃ§miÅŸe Ekle
            displayMessage(query, 'user');
            chatHistory.push({ role: 'user', parts: [{ text: query }] });
            saveActiveChatHistory();

            try {
                // 4. API'dan YanÄ±tÄ± Al
                const { text: aiResponseText, sources: aiSources } = await getGeminiResponse(query);
                
                // 5. AI MesajÄ±nÄ± GÃ¶rÃ¼ntÃ¼le ve GeÃ§miÅŸe Ekle
                displayMessage(aiResponseText, 'ai', aiSources);
                
                chatHistory.push({ 
                    role: 'ai', 
                    parts: [{ text: aiResponseText }], 
                    sources: aiSources 
                });
                
                // YanÄ±t geldikten sonra tekrar kaydet
                saveActiveChatHistory();

            } catch (error) {
                displayMessage(`Hata oluÅŸtu: ${error.message}`, 'ai');
            } finally {
                // 6. UI'Ä± SÄ±fÄ±rla
                setUILoading(false);
            }
        }

        // --- BaÅŸlangÄ±Ã§ ---
        window.onload = function() {
            loadChatsMeta();
            
            // BaÅŸlangÄ±Ã§ta sidebar'Ä±n gizli olmasÄ±nÄ± saÄŸlÄ±yoruz
            if (!sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.add('-translate-x-full');
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }

            if (!activeChatId || chatsMeta.length === 0) {
                startNewChat();
            } else {
                switchChat(activeChatId);
            }
            renderChatList();
            userInput.focus();
            
            // Audio Context'i baÅŸlat
            // Bu, TTS iÃ§in gerekli deÄŸildir, ancak gelecekteki ses iÅŸlemleri iÃ§in iyi bir uygulamadÄ±r.
            // window.AudioContext = window.AudioContext || window.webkitAudioContext;
        };

    </script>
</body>
</html>
